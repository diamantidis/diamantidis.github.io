<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>JSON feed reader app with Kotlin Native</title><!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="JSON feed reader app with Kotlin Native" /> <meta name="author" content="Ioannis Diamantidis" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A post describing how to create a JSON feed reader library with Kotlin Native and how to later use it from an iOS and an Android app" /> <meta property="og:description" content="A post describing how to create a JSON feed reader library with Kotlin Native and how to later use it from an iOS and an Android app" /> <link rel="canonical" href="https://diamantidis.github.io/2019/10/13/json-feed-reader-app-with-kotlin-native" /> <meta property="og:url" content="https://diamantidis.github.io/2019/10/13/json-feed-reader-app-with-kotlin-native" /> <meta property="og:site_name" content="Ioannis Diamantidis" /> <meta property="og:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-10-13T04:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="twitter:title" content="JSON feed reader app with Kotlin Native" /> <meta name="twitter:site" content="@diamantidis_io" /> <meta name="twitter:creator" content="@diamantidis_io" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ioannis Diamantidis","url":"https://diamantidis.github.io"},"dateModified":"2019-10-13T04:00:00+00:00","datePublished":"2019-10-13T04:00:00+00:00","description":"A post describing how to create a JSON feed reader library with Kotlin Native and how to later use it from an iOS and an Android app","headline":"JSON feed reader app with Kotlin Native","image":"https://diamantidis.github.io/assets/socialIcon.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://diamantidis.github.io/2019/10/13/json-feed-reader-app-with-kotlin-native"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://diamantidis.github.io/assets/socialIcon.png"},"name":"Ioannis Diamantidis"},"url":"https://diamantidis.github.io/2019/10/13/json-feed-reader-app-with-kotlin-native"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"><!-- Buy me a coffee widget --> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="diamantidis" data-description="Support me on Buy me a coffee!" data-message="" data-color="#347ab7" data-position="Right" data-x_margin="18" data-y_margin="18"></script> <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://diamantidis.github.io/feed.xml" title="Ioannis Diamantidis" /><script src="https://cdn.telemetrydeck.com/websdk/telemetrydeck.min.js" data-app-id='38585865-E115-4830-8D37-7A8F1213DC6B' ></script> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_sTVQpj2y4ME7gaB3ETrOfwqd4B78MrA2ixW11xju0Hg',{api_host:'https://eu.posthog.com'}) </script></head> <body><header class="site-header" role="banner"> <div class="wrapper"><div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Ioannis Diamantidis</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div><nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger" /> <label for="nav-trigger"> <span class="menu-icon"> <svg viewBox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" /> </svg> </span> </label> <div class="trigger"> <a class="page-link" href="/tips" title="Tips">Tips</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a></div> </nav></div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title break-long-word">JSON feed reader app with Kotlin Native</span> </h1> <div class="post-subheader"> <span class="post-date"> October 13, 2019 </span> <span class="post-divider">-</span> <span class="post-minutes"> 18 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#JSON+feed" title="JSON feed">JSON feed</a> <a class="post-tag" href="/tags#Kotlin" title="Kotlin">Kotlin</a> <a class="post-tag" href="/tags#Kotlin+Native" title="Kotlin Native">Kotlin Native</a> </div> </div> </div> </header> <div class="post-content"> <p>Having spent some time exploring and learning more about Kotlin Native, time has come to start building an app where I can use Kotlin Native in a real world use case. After a lot of ideas, I finally decided to build a feed reader app for this blog.</p> <p>It seems that such an app would be an ideal first project as I will have the opportunity to explore features like networking, de-serializing, storing user preference and much more that I will find out as I move on. At the same time, it doesn’t sound too demanding both in respect of time and effort.</p> <p>For the sake of this app, I will use the <a href="https://jsonfeed.org/">JSON feed</a> that I added on my Jekyll site, the process of which is documented on <a href="/2019/10/05/json-feed-for-jekyll-sites">another post</a>.</p> <p>Furthermore, I will use <a href="https://gitlab.com/diamantidis_io/kmp_template">a template</a> that I have built as a base for any Kotlin Native project, and which already includes the required setup for unit tests, linting and CI. The whole process of how I created this template has been recorded in <a href="https://diamantidis.github.io/tags#KMP">a series of posts</a>.</p> <p>So, are you ready to move on the implementation? Let’s go!</p> <h2 id="implementation">Implementation</h2> <p>First thing first, let’s start with the dependencies.</p> <p>The feed reader will have to make an HTTP request to fetch the feed and then to transform the JSON response to a Kotlin object. To implement those tasks, we are going to use <a href="https://kotlinlang.org/docs/reference/coroutines-overview.html">coroutines</a>, <a href="https://ktor.io/">ktor</a> and the <a href="https://github.com/Kotlin/kotlinx.serialization">kotlinx serialization</a>.</p> <p>To begin with, let’s define the version of the dependencies on the <code class="language-plaintext highlighter-rouge">gradle.properties</code> file, like below:</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">coroutines_version</span><span class="o">=</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">serialization_version</span><span class="o">=</span><span class="mf">0.11</span><span class="o">.</span><span class="mi">1</span>
<span class="n">ktor_version</span><span class="o">=</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">4</span>
</code></pre></div></div> <p>Next, we will have to edit <code class="language-plaintext highlighter-rouge">build.gradle</code> and add the following line on the <code class="language-plaintext highlighter-rouge">dependencies</code> block:</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">classpath</span> <span class="s2">"org.jetbrains.kotlin:kotlin-serialization:$kotlin_version"</span>
</code></pre></div></div> <p>After this, we can move to the <code class="language-plaintext highlighter-rouge">shared/build.gradle</code> file.</p> <p>First we have to add the following line to apply the kotlinx-serialization:</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'kotlinx-serialization'</span>
</code></pre></div></div> <p>and then we can define our dependencies for each target like in the following snippet:</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">commonMain</span> <span class="o">{</span>
            <span class="n">dependencies</span> <span class="o">{</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'stdlib-common'</span><span class="o">)</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-coroutines-core-common:$coroutines_version"</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-serialization-runtime-common:$serialization_version"</span>

                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-core:$ktor_version"</span>
                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-serialization:$ktor_version"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">commonTest</span> <span class="o">{</span>
            <span class="n">dependencies</span> <span class="o">{</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'test-common'</span><span class="o">)</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'test-annotations-common'</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">androidMain</span> <span class="o">{</span>
            <span class="n">dependencies</span> <span class="o">{</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'stdlib'</span><span class="o">)</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-coroutines-core-common:$coroutines_version"</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-serialization-runtime:$serialization_version"</span>

                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-core-jvm:$ktor_version"</span>
                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-serialization-jvm:$ktor_version"</span>

                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-okhttp:$ktor_version"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">androidTest</span> <span class="o">{</span>
            <span class="n">dependencies</span> <span class="o">{</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'test'</span><span class="o">)</span>
                <span class="n">implementation</span> <span class="nf">kotlin</span><span class="o">(</span><span class="s1">'test-junit'</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">iosMain</span> <span class="o">{</span>
            <span class="n">dependencies</span> <span class="o">{</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-coroutines-core-native:$coroutines_version"</span>
                <span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlinx:kotlinx-serialization-runtime-native:$serialization_version"</span>

                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-ios:$ktor_version"</span>
                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-core-native:$ktor_version"</span>
                <span class="n">implementation</span> <span class="s2">"io.ktor:ktor-client-serialization-native:$ktor_version"</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">iosTest</span> <span class="o">{</span>
        <span class="o">}</span>
</code></pre></div></div> <p>Lastly, we have to add <a href="https://kotlinlang.org/docs/reference/building-mpp-with-gradle.html#experimental-metadata-publishing-mode">another line</a> on the <code class="language-plaintext highlighter-rouge">settings.gradle</code> for the coroutines:</p> <div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">enableFeaturePreview</span><span class="o">(</span><span class="s2">"GRADLE_METADATA"</span><span class="o">)</span>
</code></pre></div></div> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/6b4f4c3d2ac7042eb9aeef8d739f741651c24570">this GitHub commit</a>.</p> </blockquote> <p>Having all the dependencies in place, we are ready to move on to the actual library.</p> <p>Let’s navigate to the <code class="language-plaintext highlighter-rouge">common</code> module inside the <code class="language-plaintext highlighter-rouge">shared</code> folder. There, we will create a package, which will host our feed reader. In my case the package name is <code class="language-plaintext highlighter-rouge">io.github.diamantidis.feedreader</code> and that will be the working directory for the rest of the post.</p> <h3 id="models">Models</h3> <p>Inside this package folder we will create a new directory named <code class="language-plaintext highlighter-rouge">model</code>, where we will place the models that will be used to map the JSON feed to a Kotlin object.</p> <p>Based on the <a href="https://diamantidis.github.io/feed.json">JSON feed file</a> we are going to need three classes, so let’s create three files inside the <code class="language-plaintext highlighter-rouge">model</code> directory: <code class="language-plaintext highlighter-rouge">Author.kt</code>, <code class="language-plaintext highlighter-rouge">Feed.kt</code> and <code class="language-plaintext highlighter-rouge">Item.kt</code> and add the following snippets respectively.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// model/Author.kt</span>
<span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.model</span>

<span class="k">import</span> <span class="nn">kotlinx.serialization.Serializable</span>

<span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">Author</span> <span class="p">(</span>
    <span class="kd">val</span> <span class="py">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">url</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>
</code></pre></div></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// model/Feed.kt</span>
<span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.model</span>

<span class="k">import</span> <span class="nn">kotlinx.serialization.SerialName</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.Serializable</span>

<span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">Feed</span> <span class="p">(</span>
    <span class="kd">val</span> <span class="py">version</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">title</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"home_page_url"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">homePageURL</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"feed_url"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">feedURL</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">description</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">icon</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">favicon</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">var</span> <span class="py">expired</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">author</span><span class="p">:</span> <span class="nc">Author</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span>
<span class="p">)</span>
</code></pre></div></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// model/Item.kt</span>
<span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.model</span>

<span class="k">import</span> <span class="nn">io.ktor.util.date.GMTDate</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.SerialName</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.Serializable</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.Transient</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.utils.parseDate</span>

<span class="nd">@Serializable</span>
<span class="kd">data class</span> <span class="nc">Item</span> <span class="p">(</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">url</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">title</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"date_published"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">datePublishedStr</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"date_modified"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">dateModifiedStr</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">author</span><span class="p">:</span> <span class="nc">Author</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">summary</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"content_html"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">contentHtml</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="nd">@Transient</span>
    <span class="kd">val</span> <span class="py">datePublished</span><span class="p">:</span> <span class="nc">GMTDate</span><span class="p">?</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">datePublishedStr</span><span class="o">?.</span><span class="nf">parseDate</span><span class="p">()</span>
    <span class="nd">@Transient</span>
    <span class="kd">val</span> <span class="py">dateModified</span><span class="p">:</span> <span class="nc">GMTDate</span><span class="p">?</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">dateModifiedStr</span><span class="o">?.</span><span class="nf">parseDate</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>As you can see from these snippets, we are using the <code class="language-plaintext highlighter-rouge">kotlinx.serialization</code> and the <code class="language-plaintext highlighter-rouge">@Serializable</code> and <code class="language-plaintext highlighter-rouge">@SerialName</code> annotations for the de-serialization. Some properties are declared optional, as they may not be on the response we are going to get from the feed. Furthermore, we make use of the <code class="language-plaintext highlighter-rouge">@Transient</code> annotation alongside a helper function named <code class="language-plaintext highlighter-rouge">parseDate()</code> and ktor’s <code class="language-plaintext highlighter-rouge">GMTDate</code> to get a date representation of the dates which are plain string properties on the JSON feed.</p> <p>For this helper function, and for any potential likewise functionality, I have created another folder named <code class="language-plaintext highlighter-rouge">utils</code>. Inside this directory a file named <code class="language-plaintext highlighter-rouge">DateFormatter.kt</code> is added with the following content:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.utils</span>

<span class="k">import</span> <span class="nn">io.ktor.util.date.GMTDate</span>
<span class="k">import</span> <span class="nn">io.ktor.util.date.Month</span>

<span class="k">internal</span> <span class="k">fun</span> <span class="nc">String</span><span class="p">.</span><span class="nf">parseDate</span><span class="p">():</span> <span class="nc">GMTDate</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">dateRegex</span> <span class="p">=</span> <span class="s">"^(-?(?:[1-9][0-9]*)?[0-9]{4})-(1[0-2]|0[1-9])-(3[01]|0[1-9]|[12][0-9])T(2[0-3]|[01][0-9]):([0-5][0-9]):([0-5][0-9])(\\\\.[0-9]+)?(Z)?"</span><span class="p">.</span><span class="nf">toRegex</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">matchResult</span> <span class="p">=</span> <span class="n">dateRegex</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="n">matchResult</span><span class="o">?.</span><span class="n">groupValues</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">year</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">month</span> <span class="p">=</span> <span class="n">it</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">day</span> <span class="p">=</span> <span class="n">it</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">hour</span> <span class="p">=</span> <span class="n">it</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">minute</span> <span class="p">=</span> <span class="n">it</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">second</span> <span class="p">=</span> <span class="n">it</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>

        <span class="k">return</span> <span class="nc">GMTDate</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="nc">Month</span><span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="n">month</span> <span class="p">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">year</span><span class="p">)</span>
    <span class="p">}</span> <span class="o">?:</span> <span class="nf">run</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nc">Error</span><span class="p">(</span><span class="s">"Error while parsing $this"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The helper function makes use of a regex to parse each component of a date field and then create an instance of <code class="language-plaintext highlighter-rouge">GMTDate</code>.</p> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/539a2b0350825c740a7193386179f2b8841b9055">this GitHub commit</a>.</p> </blockquote> <p>And that’s it with the model layer. We can now move on to the <code class="language-plaintext highlighter-rouge">Ktor</code> implementation which will be responsible for the network request and the de-serialization of the response.</p> <h3 id="networking">Networking</h3> <p>For the network we are going to create another package named <code class="language-plaintext highlighter-rouge">network</code> and inside it we are going add a new file named <code class="language-plaintext highlighter-rouge">Api.kt</code>. This file will have the following content:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.network</span>

<span class="k">import</span> <span class="nn">io.ktor.client.HttpClient</span>
<span class="k">import</span> <span class="nn">io.ktor.client.features.json.JsonFeature</span>
<span class="k">import</span> <span class="nn">io.ktor.client.features.json.serializer.KotlinxSerializer</span>
<span class="k">import</span> <span class="nn">io.ktor.client.request.HttpRequestBuilder</span>
<span class="k">import</span> <span class="nn">io.ktor.client.request.get</span>
<span class="k">import</span> <span class="nn">io.ktor.http.takeFrom</span>
<span class="k">import</span> <span class="nn">kotlinx.serialization.json.Json</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.model.Feed</span>

<span class="kd">class</span> <span class="nc">Api</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <span class="p">=</span> <span class="nc">HttpClient</span> <span class="p">{</span>
        <span class="nf">install</span><span class="p">(</span><span class="nc">JsonFeature</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serializer</span> <span class="p">=</span> <span class="nc">KotlinxSerializer</span><span class="p">(</span><span class="nc">Json</span><span class="p">.</span><span class="n">nonstrict</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
                <span class="nf">setMapper</span><span class="p">(</span><span class="nc">Feed</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="nc">Feed</span><span class="p">.</span><span class="nf">serializer</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nc">HttpRequestBuilder</span><span class="p">.</span><span class="nf">apiUrl</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">url</span> <span class="p">{</span>
            <span class="nf">takeFrom</span><span class="p">(</span><span class="s">"https://diamantidis.github.io/"</span><span class="p">)</span>
            <span class="n">encodedPath</span> <span class="p">=</span> <span class="n">path</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">fetchFeed</span><span class="p">():</span> <span class="nc">Feed</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="k">get</span> <span class="p">{</span>
        <span class="nf">apiUrl</span><span class="p">(</span><span class="s">"feed.json"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>First we create the HttpClient and define the serializer that will transform the JSON response to a Kotlin object. Then, we define a helper function to construct the URL and lastly we define the coroutine function that will make the request and return an object of the class <code class="language-plaintext highlighter-rouge">Feed</code> that we have previously mentioned.</p> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/fcb5dc3237a1fe7de82a397c8569069a2c589d9f">this GitHub commit</a>.</p> </blockquote> <h3 id="coroutines">Coroutines</h3> <p>As we said before, for our network processes, we are going to make use of <code class="language-plaintext highlighter-rouge">coroutines</code>.</p> <p>Generally it’s a good practice to not use the <code class="language-plaintext highlighter-rouge">GlobalScope</code> but rather provide a custom instance of <code class="language-plaintext highlighter-rouge">CoroutineScope</code>. Since we are working on objects with a lifecycle, we should cancel all the operation related to these objects, when they are destroyed.</p> <p>Using <code class="language-plaintext highlighter-rouge">GlobalScope</code> we have to do this manual for each operation, whereas with the use of an instance of <code class="language-plaintext highlighter-rouge">CoroutineScope</code> we can cancel all the operations of this scope by calling the function <code class="language-plaintext highlighter-rouge">cancel</code>. For more info you can refer to <a href="https://kotlinlang.org/docs/reference/coroutines/coroutine-context-and-dispatchers.html#coroutine-scope">Coroutine’s documentation</a>.</p> <p>To define a custom <code class="language-plaintext highlighter-rouge">CoroutineScope</code> provider, let’s create a file named <code class="language-plaintext highlighter-rouge">common.kt</code> and we add the following content:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader</span>

<span class="k">import</span> <span class="nn">kotlinx.coroutines.CoroutineScope</span>

<span class="k">internal</span> <span class="n">expect</span> <span class="k">fun</span> <span class="nf">ApplicationScope</span><span class="p">():</span> <span class="nc">CoroutineScope</span>
</code></pre></div></div> <p>Basically, with this snippet, we are stating that we expect for a native implementation of a <code class="language-plaintext highlighter-rouge">CoroutineScope</code> provider function from both the iOS and Android module.</p> <p>So, on the Android module, we are going to add an <code class="language-plaintext highlighter-rouge">ApplicationScope.kt</code> file containing the following snippet where we provide the actual implementation:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader</span>

<span class="k">import</span> <span class="nn">kotlinx.coroutines.CoroutineScope</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.MainScope</span>

<span class="k">internal</span> <span class="n">actual</span> <span class="k">fun</span> <span class="nf">ApplicationScope</span><span class="p">():</span> <span class="nc">CoroutineScope</span> <span class="p">=</span> <span class="nc">MainScope</span><span class="p">()</span>
</code></pre></div></div> <p>Contrary to the Android implementation, on the iOS module, we have a little more work to do. We have to create our own dispatcher, since iOS doesn’t provide a default one like Android.</p> <p>Currently there is a known open issue regarding support for <a href="https://github.com/Kotlin/kotlinx.coroutines/issues/462">multi-threaded coroutines on Kotlin/Native</a> and for this reason our custom dispatcher will use Grand Central Dispatch to run the asynchronous code on the main thread.</p> <p>For this implementation, we are going to create a new file named <code class="language-plaintext highlighter-rouge">ApplicationScope.kt</code> inside the iOS module and place the following code in it:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader</span>

<span class="k">import</span> <span class="nn">kotlinx.coroutines.CoroutineDispatcher</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.CoroutineScope</span>
<span class="k">import</span> <span class="nn">kotlinx.coroutines.Runnable</span>
<span class="k">import</span> <span class="nn">platform.darwin.dispatch_async</span>
<span class="k">import</span> <span class="nn">platform.darwin.dispatch_get_main_queue</span>
<span class="k">import</span> <span class="nn">platform.darwin.dispatch_queue_t</span>
<span class="k">import</span> <span class="nn">kotlin.coroutines.CoroutineContext</span>
<span class="k">import</span> <span class="nn">kotlin.native.concurrent.freeze</span>

<span class="k">internal</span> <span class="n">actual</span> <span class="k">fun</span> <span class="nf">ApplicationScope</span><span class="p">():</span> <span class="nc">CoroutineScope</span> <span class="p">=</span> <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">MainDispatcher</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">()))</span>

<span class="k">internal</span> <span class="kd">class</span> <span class="nc">MainDispatcher</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">dispatchQueue</span><span class="p">:</span> <span class="n">dispatch_queue_t</span><span class="p">)</span> <span class="p">:</span> <span class="nc">CoroutineDispatcher</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">CoroutineContext</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="nc">Runnable</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">dispatch_async</span><span class="p">(</span><span class="n">dispatchQueue</span><span class="p">.</span><span class="nf">freeze</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">block</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/a63b4c3e75440fb6080c3e7dfbb3539e61f975a2">this GitHub commit</a>.</p> </blockquote> <p>Now, that we are done with the model, the network and the coroutines, let’s take some time to focus on the presentation.</p> <h3 id="presentation">Presentation</h3> <p>For the presentation logic, we are going to create yet another folder named <code class="language-plaintext highlighter-rouge">presentation</code>. Since we have to perform a network request, every view that is going to fetch this feed will have to handle three states: Loading the data, a potential error and of course the successful scenario, in which case the feed info is fetched.</p> <p>To cater for all these scenarios we are going to define an interface that our native views will have to implement. For this reason, let’s create a file named <code class="language-plaintext highlighter-rouge">FeedView.kt</code> and add the following as a content:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.presentation</span>

<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.model.Feed</span>

<span class="kd">interface</span> <span class="nc">FeedView</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">showData</span><span class="p">(</span><span class="n">feed</span><span class="p">:</span> <span class="nc">Feed</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">showError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">showLoading</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>We simply declare the three functions that we are going to call depending on the state of the request.</p> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/b9ffc627d1893401b14b767711f2858a55db919e">this GitHub commit</a>.</p> </blockquote> <p>And now it’s time to connect all these pieces together. We are following the MVP pattern, so we will define a presenter that will interact with the view both to fetch the data and to update the UI depending on the response of the network request.</p> <h3 id="presenter">Presenter</h3> <p>Let’s create a new folder named <code class="language-plaintext highlighter-rouge">presenter</code> and a new file named <code class="language-plaintext highlighter-rouge">FeedPresenter.kt</code>. Next, add the following snippet in this file.</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.presenter</span>

<span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.ApplicationScope</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.model.Feed</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.network.Api</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.presentation.FeedView</span>

<span class="kd">class</span> <span class="nc">FeedPresenter</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">view</span><span class="p">:</span> <span class="nc">FeedView</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">api</span><span class="p">:</span> <span class="nc">Api</span> <span class="p">=</span> <span class="nc">Api</span><span class="p">(),</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">mainScope</span><span class="p">:</span> <span class="nc">CoroutineScope</span> <span class="p">=</span> <span class="nc">ApplicationScope</span><span class="p">()</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">loadData</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">view</span><span class="p">.</span><span class="nf">showLoading</span><span class="p">()</span>

        <span class="n">mainScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">val</span> <span class="py">result</span><span class="p">:</span> <span class="nc">Feed</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="nf">fetchFeed</span><span class="p">()</span>
                <span class="n">view</span><span class="p">.</span><span class="nf">showData</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">view</span><span class="p">.</span><span class="nf">showError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">=</span> <span class="n">mainScope</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this class we inject the view that will present the data, using the interface we created earlier. We also inject the dependencies like the <code class="language-plaintext highlighter-rouge">CoroutineScope</code> and the <code class="language-plaintext highlighter-rouge">Api</code>, providing some default values.</p> <p>For now, the main functionalities of this class are just two. One to initialize the process of fetching the feed and one for cancelling any pending process. The first function, <code class="language-plaintext highlighter-rouge">loadData</code>, is responsible for triggering the network request and notifying the view about the state changes by calling the corresponding function declared in the <code class="language-plaintext highlighter-rouge">FeedView</code> interface.</p> <p>The <code class="language-plaintext highlighter-rouge">destroy</code> function will be called to terminate all the operations on the injected scope when the caller object is going to be destroyed.</p> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/1a61e0ccc8f0c3583b813dd7ea1d53b77d484e44">this GitHub commit</a>.</p> </blockquote> <p>With the above implementation of <code class="language-plaintext highlighter-rouge">FeedPresenter</code> we should be done and ready to use our library from an iOS or Android app. Though on Android it is possible to create a new instance of the presenter by just calling <code class="language-plaintext highlighter-rouge">private val presenter: FeedPresenter by lazy { FeedPresenter(this) }</code> from an activity that implements the <code class="language-plaintext highlighter-rouge">FeedView</code> interface, on iOS is not so easy. Default constructors are not working as expected, so we have to instantiate a new instance of <code class="language-plaintext highlighter-rouge">Api</code> and <code class="language-plaintext highlighter-rouge">CoroutineScope</code>. Using a factory class would be a good alternative.</p> <h2 id="factory">Factory</h2> <p>For this reason, let’s create a new directory named <code class="language-plaintext highlighter-rouge">factory</code> and place a file named <code class="language-plaintext highlighter-rouge">PresenterFactory.kt</code> inside it. Then, we put the following snippet as content to this file:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.feedreader.factory</span>

<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.presentation.FeedView</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.presenter.FeedPresenter</span>

<span class="kd">class</span> <span class="nc">PresenterFactory</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">fun</span> <span class="nf">createFeedPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">FeedView</span><span class="p">)</span> <span class="p">=</span> <span class="nc">FeedPresenter</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this file, we just declare a method on the companion object to instantiate the Presenter.</p> <p>Then we can use this class to create our presenter on both iOS and Android, like in the following snippets:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Android</span>
<span class="k">private</span> <span class="kd">val</span> <span class="py">presenter</span><span class="p">:</span> <span class="nc">FeedPresenter</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span> <span class="nc">PresenterFactory</span><span class="p">.</span><span class="nf">createFeedPresenter</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// iOS</span>
<span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">presenter</span> <span class="o">=</span> <span class="kt">PresenterFactory</span><span class="o">.</span><span class="kt">Companion</span><span class="p">()</span><span class="o">.</span><span class="nf">createFeedPresenter</span><span class="p">(</span><span class="nv">view</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p>All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/cc5f4c3adb70ac6e4e43141e459cd308e88724cf">this GitHub commit</a>.</p> </blockquote> <p>Now, our JSON feed reader library is ready to be used on the apps. Let’s see how!</p> <h2 id="android-app">Android app</h2> <p>For the Android app we have to implement the <code class="language-plaintext highlighter-rouge">FeedView</code> interface on our <code class="language-plaintext highlighter-rouge">MainActivity</code>, lazy initialize the <code class="language-plaintext highlighter-rouge">FeedPresenter</code> and then by calling the function <code class="language-plaintext highlighter-rouge">loadData</code> to fetch the feed. We then make use of an <code class="language-plaintext highlighter-rouge">ArrayAdapter</code> to populate a <code class="language-plaintext highlighter-rouge">ListView</code> with the titles of the post items.</p> <p>A dummy activity could be like the following example:</p> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">io.github.diamantidis.androidApp</span>

<span class="k">import</span> <span class="nn">android.content.Context</span>
<span class="k">import</span> <span class="nn">android.support.v7.app.AppCompatActivity</span>
<span class="k">import</span> <span class="nn">android.os.Bundle</span>
<span class="k">import</span> <span class="nn">android.view.View</span>
<span class="k">import</span> <span class="nn">android.view.ViewGroup</span>
<span class="k">import</span> <span class="nn">android.widget.*</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.factory.PresenterFactory</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.model.Feed</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.model.Item</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.presentation.FeedView</span>
<span class="k">import</span> <span class="nn">io.github.diamantidis.feedreader.presenter.FeedPresenter</span>

<span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">(),</span> <span class="nc">FeedView</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">showData</span><span class="p">(</span><span class="n">feed</span><span class="p">:</span> <span class="nc">Feed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">adapter</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">adapter</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="n">feed</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">showLoading</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Loading"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">showError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"show error: ${error.message}"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">listView</span> <span class="p">=</span> <span class="nc">ListView</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="n">adapter</span> <span class="p">=</span> <span class="nc">FeedAdapter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nf">mutableListOf</span><span class="p">())</span>
        <span class="n">listView</span><span class="p">.</span><span class="n">adapter</span> <span class="p">=</span> <span class="n">adapter</span>

        <span class="n">presenter</span><span class="p">.</span><span class="nf">loadData</span><span class="p">()</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">setContentView</span><span class="p">(</span><span class="n">listView</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">adapter</span><span class="p">:</span> <span class="nc">FeedAdapter</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">presenter</span><span class="p">:</span> <span class="nc">FeedPresenter</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span> <span class="nc">PresenterFactory</span><span class="p">.</span><span class="nf">createFeedPresenter</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">}</span>

    <span class="k">private</span> <span class="k">inner</span> <span class="kd">class</span> <span class="nc">FeedAdapter</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;)</span> <span class="p">:</span>
        <span class="nc">ArrayAdapter</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;(</span><span class="n">context</span><span class="p">,</span> <span class="p">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">getView</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">convertView</span><span class="p">:</span> <span class="nc">View</span><span class="p">?,</span> <span class="n">parent</span><span class="p">:</span> <span class="nc">ViewGroup</span><span class="p">):</span> <span class="nc">View</span> <span class="p">{</span>

            <span class="kd">val</span> <span class="py">item</span> <span class="p">=</span> <span class="k">super</span><span class="p">.</span><span class="nf">getItem</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">listLayout</span> <span class="p">=</span> <span class="nc">LinearLayout</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">listLayout</span><span class="p">.</span><span class="n">layoutParams</span> <span class="p">=</span> <span class="nc">AbsListView</span><span class="p">.</span><span class="nc">LayoutParams</span><span class="p">(</span>
                <span class="nc">AbsListView</span><span class="p">.</span><span class="nc">LayoutParams</span><span class="p">.</span><span class="nc">WRAP_CONTENT</span><span class="p">,</span>
                <span class="nc">AbsListView</span><span class="p">.</span><span class="nc">LayoutParams</span><span class="p">.</span><span class="nc">WRAP_CONTENT</span>
            <span class="p">)</span>
            <span class="kd">val</span> <span class="py">listText</span> <span class="p">=</span> <span class="nc">TextView</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">listText</span><span class="p">.</span><span class="nf">setPadding</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
            <span class="n">listText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">item</span><span class="o">?.</span><span class="n">title</span>

            <span class="n">listLayout</span><span class="p">.</span><span class="nf">addView</span><span class="p">(</span><span class="n">listText</span><span class="p">)</span>

            <span class="n">listLayout</span><span class="p">.</span><span class="nf">setTag</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">listLayout</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Besides that, a few more changes are required on the <code class="language-plaintext highlighter-rouge">build.gradle</code> and the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code>. All these changes can be found on <a href="https://github.com/diamantidis/BlogApp/commit/3b6b5d7a25bb3e358f4dbd375960e57b8f363929">this GitHub commit</a>.</p> <h2 id="ios-app">iOS app</h2> <p>Similarly for iOS, we follow a similar procedure; implement the <code class="language-plaintext highlighter-rouge">FeedView</code> interface from our <code class="language-plaintext highlighter-rouge">UIViewController</code>, lazy initialize the <code class="language-plaintext highlighter-rouge">FeedPresenter</code> and then call the <code class="language-plaintext highlighter-rouge">loadData</code> function, though instead of a <code class="language-plaintext highlighter-rouge">ListView</code> we make use of the equivalent on iOS, which is a <code class="language-plaintext highlighter-rouge">UITableView</code>.</p> <p>A dummy UIViewController could be like the following example:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="n">shared</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="kt">FeedView</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">showError</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="kt">KotlinThrowable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">activityIndicatorView</span><span class="o">.</span><span class="nf">stopAnimating</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">showData</span><span class="p">(</span><span class="nv">feed</span><span class="p">:</span> <span class="kt">Feed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">activityIndicatorView</span><span class="o">.</span><span class="nf">stopAnimating</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="o">.</span><span class="n">singleLine</span>
        <span class="k">self</span><span class="o">.</span><span class="n">posts</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">items</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">showLoading</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="o">.</span><span class="k">none</span>
        <span class="n">activityIndicatorView</span><span class="o">.</span><span class="nf">startAnimating</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

        <span class="k">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>
        <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">activate</span><span class="p">([</span>
            <span class="n">tableView</span><span class="o">.</span><span class="n">leadingAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">leadingAnchor</span><span class="p">),</span>
            <span class="n">tableView</span><span class="o">.</span><span class="n">trailingAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">trailingAnchor</span><span class="p">),</span>
            <span class="n">tableView</span><span class="o">.</span><span class="n">bottomAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">bottomAnchor</span><span class="p">),</span>
            <span class="n">tableView</span><span class="o">.</span><span class="n">topAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">topAnchor</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">tableView</span><span class="o">.</span><span class="n">backgroundView</span> <span class="o">=</span> <span class="n">activityIndicatorView</span>
        <span class="n">presenter</span><span class="o">.</span><span class="nf">loadData</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">posts</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]()</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">presenter</span> <span class="o">=</span> <span class="kt">PresenterFactory</span><span class="o">.</span><span class="kt">Companion</span><span class="p">()</span><span class="o">.</span><span class="nf">createFeedPresenter</span><span class="p">(</span><span class="nv">view</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">activityIndicatorView</span> <span class="o">=</span> <span class="kt">UIActivityIndicatorView</span><span class="p">(</span><span class="nv">activityIndicatorStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">gray</span><span class="p">)</span>

    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">tableView</span> <span class="o">=</span> <span class="kt">UITableView</span><span class="p">()</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">UITableViewCell</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forCellReuseIdentifier</span><span class="p">:</span> <span class="s">"MyCell"</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">tableView</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">tableView</span><span class="o">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="o">.</span><span class="k">none</span>
        <span class="n">tableView</span><span class="o">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="n">tableView</span>
    <span class="p">}()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UITableViewDelegate</span><span class="p">,</span> <span class="kt">UITableViewDataSource</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">numberOfSections</span><span class="p">(</span><span class="k">in</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">posts</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">posts</span><span class="o">.</span><span class="n">count</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="s">"MyCell"</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span> <span class="k">as</span> <span class="kt">IndexPath</span><span class="p">)</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">accessoryType</span> <span class="o">=</span> <span class="o">.</span><span class="n">disclosureIndicator</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">!.</span><span class="n">text</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">cell</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Again, all the changes required to build a dummy iOS app that will use the JSON feed reader library, can be found on <a href="https://github.com/diamantidis/BlogApp/commit/8c69b9ef7d856c3fb26c1d7eda0fb3c0f4ebae9b">this GitHub commit</a>.</p> <h2 id="conclusion">Conclusion</h2> <p>To sum up, this post describes how to implement a JSON feed reader library with Kotlin Native and how to use it from both an Android and an iOS app. While building this library, we have seen how to use <code class="language-plaintext highlighter-rouge">ktor</code> to implement the network request, utilize <code class="language-plaintext highlighter-rouge">kotlinx-serialization</code>’s power to de-serialize the JSON response into a Kotlin object, learn how to work with <code class="language-plaintext highlighter-rouge">coroutines</code> and take advantage of the <code class="language-plaintext highlighter-rouge">MVP</code> pattern to communicate between the Kotlin Native library and the native application.</p> <p>Definitely the process of building this app, though it still lacks some basic functionality, helped me a lot to get more acquainted with Kotlin Native. Next step? To iterate over this implementation and add some more features like presenting the content of the post or adding some caching layer!!</p> <p>Thanks for reading and should you have any questions, suggestions or comments, just let me know on <a href="https://twitter.com/diamantidis_io">Twitter</a> or <a href="mailto:diamantidis@outlook.com">email me</a>!!</p> </div> <div class="socials"> <!-- Buy me a coffee button --> <a href="https://www.buymeacoffee.com/diamantidis" target="_blank"> <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" > </a> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=JSON+feed+reader+app+with+Kotlin+Native&url=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F13%2Fjson-feed-reader-app-with-kotlin-native" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=JSON+feed+reader+app+with+Kotlin+Native&u=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F13%2Fjson-feed-reader-app-with-kotlin-native" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F13%2Fjson-feed-reader-app-with-kotlin-native" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </div></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> © Copyright 2024 Ioannis Diamantidis </p> </div> </footer></body> </html>
