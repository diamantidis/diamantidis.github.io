<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>Running a SwiftNIO Server in an iOS app</title><!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="Running a SwiftNIO Server in an iOS app" /> <meta name="author" content="Ioannis Diamantidis" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A post on how to use SwiftNIO to run an HTTP server from an iOS app" /> <meta property="og:description" content="A post on how to use SwiftNIO to run an HTTP server from an iOS app" /> <link rel="canonical" href="https://diamantidis.github.io/2019/10/27/swift-nio-server-in-an-ios-app" /> <meta property="og:url" content="https://diamantidis.github.io/2019/10/27/swift-nio-server-in-an-ios-app" /> <meta property="og:site_name" content="Ioannis Diamantidis" /> <meta property="og:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-10-27T04:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="twitter:title" content="Running a SwiftNIO Server in an iOS app" /> <meta name="twitter:site" content="@diamantidis_io" /> <meta name="twitter:creator" content="@diamantidis_io" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ioannis Diamantidis","url":"https://diamantidis.github.io"},"dateModified":"2019-10-27T04:00:00+00:00","datePublished":"2019-10-27T04:00:00+00:00","description":"A post on how to use SwiftNIO to run an HTTP server from an iOS app","headline":"Running a SwiftNIO Server in an iOS app","image":"https://diamantidis.github.io/assets/socialIcon.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://diamantidis.github.io/2019/10/27/swift-nio-server-in-an-ios-app"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://diamantidis.github.io/assets/socialIcon.png"},"name":"Ioannis Diamantidis"},"url":"https://diamantidis.github.io/2019/10/27/swift-nio-server-in-an-ios-app"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"><!-- Buy me a coffee widget --> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="diamantidis" data-description="Support me on Buy me a coffee!" data-message="" data-color="#347ab7" data-position="Right" data-x_margin="18" data-y_margin="18"></script> <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://diamantidis.github.io/feed.xml" title="Ioannis Diamantidis" /><script src="https://cdn.telemetrydeck.com/websdk/telemetrydeck.min.js" data-app-id='38585865-E115-4830-8D37-7A8F1213DC6B' ></script> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_sTVQpj2y4ME7gaB3ETrOfwqd4B78MrA2ixW11xju0Hg',{api_host:'https://eu.posthog.com'}) </script></head> <body><header class="site-header" role="banner"> <div class="wrapper"><div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Ioannis Diamantidis</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div><nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger" /> <label for="nav-trigger"> <span class="menu-icon"> <svg viewBox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" /> </svg> </span> </label> <div class="trigger"> <a class="page-link" href="/tips" title="Tips">Tips</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a></div> </nav></div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title break-long-word">Running a SwiftNIO Server in an iOS app</span> </h1> <div class="post-subheader"> <span class="post-date"> October 27, 2019 </span> <span class="post-divider">-</span> <span class="post-minutes"> 8 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#Swift" title="Swift">Swift</a> <a class="post-tag" href="/tags#SwiftNIO" title="SwiftNIO">SwiftNIO</a> <a class="post-tag" href="/tags#iOS" title="iOS">iOS</a> </div> </div> </div> </header> <div class="post-content"> <p>Have you ever wondered if it is possible to run a server in an iOS app? A while ago I had this question! It seems that <a href="https://github.com/apple/swift-nio">SwiftNIO</a> and <a href="https://github.com/apple/swift-nio-transport-services">SwiftNIO Transport Services extension, a.k.a NIOTS</a> are here to help us do so.</p> <p>SwiftNIO is a non-blocking event-driven network framework and as per the documentation, it is like <a href="https://netty.io/">Netty</a>, but written for Swift, meaning that it is following Netty’s architecture and concepts though in a Swifty way.</p> <p>To get a better grasp of the architecture, you can refer to <a href="https://github.com/apple/swift-nio#basic-architecture">SwiftNIO’s documentation</a>, where you can find a detailed description of the building blocks and how they interact with each other.</p> <p>Back to our topic, a potential use case for such an app could be to act as a mock server for other apps. For example, such a mock server app could be used for usability testing, especially if it provides a UI to manipulate the responses and thus enabling the person performing the usability testing to create different scenarios and flows in the app.</p> <p>So, for this post, I will try to create a simple app that will start an HTTP server, and this server will handle a GET request and return a JSON response.</p> <h2 id="implementation">Implementation</h2> <h1 id="dependencies">Dependencies</h1> <p>First thing first, we have to add <code class="language-plaintext highlighter-rouge">SwiftNIO</code>, <code class="language-plaintext highlighter-rouge">SwiftNIOTransportServices</code> and <code class="language-plaintext highlighter-rouge">SwiftNIOHTTP1</code> as dependencies to our project. Let’s open the <code class="language-plaintext highlighter-rouge">Podfile</code> and add the following dependencies:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">pod</span> <span class="s1">'SwiftNIO'</span><span class="p">,</span> <span class="s1">'~&gt; 2.0.0'</span>
  <span class="n">pod</span> <span class="s1">'SwiftNIOTransportServices'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0.0'</span>
  <span class="n">pod</span> <span class="s1">'SwiftNIOHTTP1'</span><span class="p">,</span> <span class="s1">'~&gt; 2.0.0'</span>
</code></pre></div></div> <p>After that, run <code class="language-plaintext highlighter-rouge">bundle exec pod install</code> and wait until the Pods are installed.</p> <p>Having installed the dependencies we are ready to move to the actual implementation.</p> <h1 id="channelhandler">ChannelHandler</h1> <p>To do the data manipulation, <code class="language-plaintext highlighter-rouge">SwiftNIO</code> is using the terms <code class="language-plaintext highlighter-rouge">ChannelPipeline</code>, <code class="language-plaintext highlighter-rouge">ChannelHandler</code> and <code class="language-plaintext highlighter-rouge">ChannelContext</code>.</p> <blockquote> <p>For a thorough description of what each of these building blocks is, you can refer to the <a href="https://github.com/apple/swift-nio#channels-channel-handlers-channel-pipelines-and-channel-contexts">corresponding documentation</a>.</p> </blockquote> <p>Long story short, <code class="language-plaintext highlighter-rouge">ChannelHandler</code> is a base protocol for handlers that handle I/O events or intercept an I/O operation.</p> <p><a href="https://apple.github.io/swift-nio/docs/current/NIO/Protocols/ChannelHandler.html"><code class="language-plaintext highlighter-rouge">ChannelHandler</code></a> should not be used directly but rather through its sub-protocols. A ChannelHandler can be Inbound, Outbound or both. The first one refers to handlers which process inbound events like reading data, while the second refers to handlers which process outbound events like writes.</p> <p>Those handlers are added to a sequence, the <code class="language-plaintext highlighter-rouge">ChannelPipeline</code>. Then, with each new event, each handler processes the event in order. For read events that order is from the front to the back of the sequence whereas for write events is the reverse order.</p> <p>Finally, each handler is using <code class="language-plaintext highlighter-rouge">ChannelHandlerContext</code> to communicate with other handlers by emitting events.</p> <p>In our case, we are going to create a class that conforms to <code class="language-plaintext highlighter-rouge">ChannelInboundHandler</code>, and its main responsibility will be to read the data coming from any other previous <code class="language-plaintext highlighter-rouge">ChannelInboundHandler</code> and prepare the response and the corresponding header which will be forwarded to the next <code class="language-plaintext highlighter-rouge">ChannelHandler</code> using the <code class="language-plaintext highlighter-rouge">ChannelHandlerContext</code>.</p> <p>An example of a dummy <code class="language-plaintext highlighter-rouge">ChannelInboundHandler</code> is the following:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">NIOHTTP1</span>
<span class="kd">import</span> <span class="kt">NIO</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DummyHandler</span><span class="p">:</span> <span class="kt">ChannelInboundHandler</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">InboundIn</span> <span class="o">=</span> <span class="kt">HTTPServerRequestPart</span>
    <span class="kd">typealias</span> <span class="kt">OutboundOut</span> <span class="o">=</span> <span class="kt">HTTPServerResponsePart</span>

    <span class="kd">func</span> <span class="nf">channelRead</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ChannelHandlerContext</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">NIOAny</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">part</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">unwrapInboundIn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">part</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// Prepare the response body</span>
        <span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="p">[</span><span class="s">"message"</span><span class="p">:</span> <span class="s">"Hello World"</span><span class="p">]</span>
        <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1">// set the headers</span>
        <span class="k">var</span> <span class="nv">headers</span> <span class="o">=</span> <span class="kt">HTTPHeaders</span><span class="p">()</span>
        <span class="n">headers</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Content-Type"</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Content-Length"</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="n">response</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">responseHead</span> <span class="o">=</span> <span class="kt">HTTPResponseHead</span><span class="p">(</span><span class="nv">version</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">major</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">minor</span><span class="p">:</span> <span class="mi">1</span><span class="p">),</span> <span class="nv">status</span><span class="p">:</span> <span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="nv">headers</span><span class="p">:</span> <span class="n">headers</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="nf">wrapOutboundOut</span><span class="p">(</span><span class="o">.</span><span class="nf">head</span><span class="p">(</span><span class="n">responseHead</span><span class="p">)),</span> <span class="nv">promise</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

        <span class="c1">// Set the data</span>
        <span class="k">var</span> <span class="nv">buffer</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="nf">buffer</span><span class="p">(</span><span class="nv">capacity</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="nf">writeBytes</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">body</span> <span class="o">=</span> <span class="kt">HTTPServerResponsePart</span><span class="o">.</span><span class="nf">body</span><span class="p">(</span><span class="o">.</span><span class="nf">byteBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
        <span class="n">context</span><span class="o">.</span><span class="nf">writeAndFlush</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="nf">wrapOutboundOut</span><span class="p">(</span><span class="n">body</span><span class="p">),</span> <span class="nv">promise</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>First we declare the <code class="language-plaintext highlighter-rouge">InboundIn</code> and the <code class="language-plaintext highlighter-rouge">OutboundOut</code> types. <code class="language-plaintext highlighter-rouge">InboundIn</code> defines the kind of data that this handler is expecting to receive from any previous <code class="language-plaintext highlighter-rouge">ChannelHandler</code> whereas <code class="language-plaintext highlighter-rouge">OutboundOut</code> is the kind of data that will be forwarded to the next.</p> <p>In our case they are <code class="language-plaintext highlighter-rouge">HTTPServerRequestPart</code> and <code class="language-plaintext highlighter-rouge">HTTPServerResponsePart</code> respectively, both of which are typeliases for the generic enum <code class="language-plaintext highlighter-rouge">HTTPPart&lt;HeadT: Equatable, BodyT: Equatable&gt;</code> that contains three cases; <code class="language-plaintext highlighter-rouge">.head</code>, <code class="language-plaintext highlighter-rouge">.body</code> and <code class="language-plaintext highlighter-rouge">.end</code>.</p> <p>After that, we provide an implementation for the <code class="language-plaintext highlighter-rouge">channelRead</code> function which is called when there are some data to be read. The data is passed as a <code class="language-plaintext highlighter-rouge">NIOAny</code> object, so we have to unwrap it to the <code class="language-plaintext highlighter-rouge">InboundIn</code> type. Next, we prepare the data that we want as a response. In our case it is a simple map and we use the <code class="language-plaintext highlighter-rouge">JSONEncoder</code> to encode it into data.</p> <p>Then, we set the response headers, which consist of the <code class="language-plaintext highlighter-rouge">Content-Type</code> and the <code class="language-plaintext highlighter-rouge">Content-Length</code> headers and using the <code class="language-plaintext highlighter-rouge">context.write</code> we are sending an event to the next <code class="language-plaintext highlighter-rouge">ChannelHandler</code> in the <code class="language-plaintext highlighter-rouge">ChannelPipeline</code>.</p> <p>Carrying on, we create a buffer with the response data and we set it as the body of the response. We are also calling the <code class="language-plaintext highlighter-rouge">writeAndFlush</code> function which is sending a <code class="language-plaintext highlighter-rouge">write</code> event to the next <code class="language-plaintext highlighter-rouge">ChannelHandler</code> followed by a <code class="language-plaintext highlighter-rouge">flush</code> event. With the <code class="language-plaintext highlighter-rouge">write</code> event the body data will be enqueued to be written to the socket when the <code class="language-plaintext highlighter-rouge">flush</code> event arrives.</p> <p>Now, let’s move to the server that will use this <code class="language-plaintext highlighter-rouge">ChannelHandler</code>!</p> <h1 id="server">Server</h1> <p>An example of a server that is using the <code class="language-plaintext highlighter-rouge">ChannelHandler</code> can be found on the following snippet.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">NIOTransportServices</span>
<span class="kd">import</span> <span class="kt">NIO</span>

<span class="kd">class</span> <span class="kt">Server</span> <span class="p">{</span>
    <span class="c1">// MARK: - Initializers</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">host</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="k">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Public functions</span>
    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">bootstrap</span> <span class="o">=</span> <span class="kt">NIOTSListenerBootstrap</span><span class="p">(</span><span class="nv">group</span><span class="p">:</span> <span class="n">group</span><span class="p">)</span>
                <span class="o">.</span><span class="n">childChannelInitializer</span> <span class="p">{</span> <span class="n">channel</span> <span class="k">in</span>
                    <span class="n">channel</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="nf">configureHTTPServerPipeline</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span>
                            <span class="n">channel</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="nf">addHandler</span><span class="p">(</span><span class="kt">DummyHandler</span><span class="p">())</span>
                    <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">let</span> <span class="nv">channel</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bootstrap</span>
                <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">host</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="nv">port</span><span class="p">:</span> <span class="n">port</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
            
            <span class="k">try</span> <span class="n">channel</span><span class="o">.</span><span class="n">closeFuture</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"An error happed </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">group</span><span class="o">.</span><span class="nf">syncShutdownGracefully</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"An error happed </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Private properties</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">group</span> <span class="o">=</span> <span class="kt">NIOTSEventLoopGroup</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">port</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this class, we define an initializer with a <code class="language-plaintext highlighter-rouge">host</code> and <code class="language-plaintext highlighter-rouge">port</code> variable and two functions; <code class="language-plaintext highlighter-rouge">start</code> and <code class="language-plaintext highlighter-rouge">stop</code> which are, as you can imagine, responsible to start and stop the server.</p> <p>Let’s focus on the <code class="language-plaintext highlighter-rouge">start</code> function first.</p> <p>Initially, we have to bootstrap our channel. We are using the <code class="language-plaintext highlighter-rouge">NIOTSListenerBootstrap</code> to do so and its <code class="language-plaintext highlighter-rouge">childChannelInitializer</code> function to add ChannelHandlers to the ChannelPipeline. To add HTTP-server capabilities to our server, we call the <code class="language-plaintext highlighter-rouge">configureHTTPServerPipeline</code> which adds some HTTP-related ChannelHandlers to the ChannelPipeline. After that, we are using flatMap to add our own <code class="language-plaintext highlighter-rouge">DummyHandler</code> to the <code class="language-plaintext highlighter-rouge">ChannelPipeline</code>. We are, then, using this bootstrap to bind our channel to the port and the host set through the initializer and finally, we are using <code class="language-plaintext highlighter-rouge">try channel.closeFuture.wait()</code> to make our server run until we decide to close it.</p> <p>As for the <code class="language-plaintext highlighter-rouge">stop</code> function, we just call <code class="language-plaintext highlighter-rouge">try group.syncShutdownGracefully()</code> to shut down the <code class="language-plaintext highlighter-rouge">EventLoopGroup</code> gracefully.</p> <h1 id="results">Results</h1> <p>The last missing piece to run our server is to initialize a server instance and call the <code class="language-plaintext highlighter-rouge">start</code> function, like in the following lines:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">app</span> <span class="o">=</span> <span class="kt">Server</span><span class="p">(</span><span class="nv">host</span><span class="p">:</span> <span class="s">"localhost"</span><span class="p">,</span> <span class="nv">port</span><span class="p">:</span> <span class="mi">8888</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div> <p>And we are ready to run the app!</p> <p>Now, if you head to the Terminal and execute the command <code class="language-plaintext highlighter-rouge">curl -X GET http://localhost:8888</code> (requires to have <code class="language-plaintext highlighter-rouge">curl</code> installed) or use a browser either on the device or the emulator that you use to run the app, and you visit <code class="language-plaintext highlighter-rouge">http://localhost:8888</code>, you will receive the <code class="language-plaintext highlighter-rouge">{"message":"Hello World"}</code> response.</p> <h2 id="conclusion">Conclusion</h2> <p>To sum up, in this post, we have seen how to use <code class="language-plaintext highlighter-rouge">SwiftNIO</code> in an iOS app to run an HTTP server that will serve a static JSON response.</p> <p>But given that SwiftNIO is a low-level framework, in order to reach my goal of building a mock server app, there are a lot of things to be implemented, like a routing implementation that will make it easy to change the response on the fly.</p> <p>For this reason, as alternatives to SwiftNIO, there are also some other high-level framework that you can also use to run a server on an iOS app, such as <a href="https://github.com/swisspol/GCDWebServer">GCDWebServer</a>, <a href="https://github.com/httpswift/swifter">swifter</a>, <a href="https://github.com/envoy/Ambassador">Ambassador</a> and <a href="https://github.com/IBM-Swift/Kitura-Mobile-Server">Kitura</a>.</p> <p>SwiftNIO or not, knowing that it is possible to run a server in an iOS app is something that could be useful in many ways!!</p> <p>Thanks for reading and should you have any questions, suggestions or comments, just let me know on <a href="https://twitter.com/diamantidis_io">Twitter</a> or <a href="mailto:diamantidis@outlook.com">email me</a>!!</p> </div> <div class="socials"> <!-- Buy me a coffee button --> <a href="https://www.buymeacoffee.com/diamantidis" target="_blank"> <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" > </a> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=Running+a+SwiftNIO+Server+in+an+iOS+app&url=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F27%2Fswift-nio-server-in-an-ios-app" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=Running+a+SwiftNIO+Server+in+an+iOS+app&u=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F27%2Fswift-nio-server-in-an-ios-app" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fdiamantidis.github.io%2F2019%2F10%2F27%2Fswift-nio-server-in-an-ios-app" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </div></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> © Copyright 2024 Ioannis Diamantidis </p> </div> </footer></body> </html>
