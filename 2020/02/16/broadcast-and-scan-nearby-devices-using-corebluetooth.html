<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>Scan and broadcast to nearby devices with Core Bluetooth</title><!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="Scan and broadcast to nearby devices with Core Bluetooth" /> <meta name="author" content="Ioannis Diamantidis" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A post about how to implement a Catalyst app to scan and advertise to nearby devices using Swift and Core Bluetooth framework" /> <meta property="og:description" content="A post about how to implement a Catalyst app to scan and advertise to nearby devices using Swift and Core Bluetooth framework" /> <link rel="canonical" href="https://diamantidis.github.io/2020/02/16/broadcast-and-scan-nearby-devices-using-corebluetooth" /> <meta property="og:url" content="https://diamantidis.github.io/2020/02/16/broadcast-and-scan-nearby-devices-using-corebluetooth" /> <meta property="og:site_name" content="Ioannis Diamantidis" /> <meta property="og:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-02-16T04:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="twitter:title" content="Scan and broadcast to nearby devices with Core Bluetooth" /> <meta name="twitter:site" content="@diamantidis_io" /> <meta name="twitter:creator" content="@diamantidis_io" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ioannis Diamantidis","url":"https://diamantidis.github.io"},"dateModified":"2020-02-16T04:00:00+00:00","datePublished":"2020-02-16T04:00:00+00:00","description":"A post about how to implement a Catalyst app to scan and advertise to nearby devices using Swift and Core Bluetooth framework","headline":"Scan and broadcast to nearby devices with Core Bluetooth","image":"https://diamantidis.github.io/assets/socialIcon.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://diamantidis.github.io/2020/02/16/broadcast-and-scan-nearby-devices-using-corebluetooth"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://diamantidis.github.io/assets/socialIcon.png"},"name":"Ioannis Diamantidis"},"url":"https://diamantidis.github.io/2020/02/16/broadcast-and-scan-nearby-devices-using-corebluetooth"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"><!-- Buy me a coffee widget --> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="diamantidis" data-description="Support me on Buy me a coffee!" data-message="" data-color="#347ab7" data-position="Right" data-x_margin="18" data-y_margin="18"></script> <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://diamantidis.github.io/feed.xml" title="Ioannis Diamantidis" /><script src="https://cdn.telemetrydeck.com/websdk/telemetrydeck.min.js" data-app-id='38585865-E115-4830-8D37-7A8F1213DC6B' ></script> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_sTVQpj2y4ME7gaB3ETrOfwqd4B78MrA2ixW11xju0Hg',{api_host:'https://eu.posthog.com'}) </script></head> <body><header class="site-header" role="banner"> <div class="wrapper">
<div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Ioannis Diamantidis</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div>
<nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger"> <label for="nav-trigger"> <span class="menu-icon"> <svg viewbox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path> </svg> </span> </label> <div class="trigger"> <a class="page-link" href="/tips" title="Tips">Tips</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a>
</div> </nav>
</div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title break-long-word">Scan and broadcast to nearby devices with Core Bluetooth</span> </h1> <div class="post-subheader"> <span class="post-date"> February 16, 2020 </span> <span class="post-divider">-</span> <span class="post-minutes"> 11 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#Swift" title="Swift">Swift</a> <a class="post-tag" href="/tags#Core+Bluetooth" title="Core Bluetooth">Core Bluetooth</a> <a class="post-tag" href="/tags#Catalyst" title="Catalyst">Catalyst</a> <a class="post-tag" href="/tags#iOS" title="iOS">iOS</a> </div> </div> </div> </header> <div class="post-content"> <p>The topic of this post is about Bluetooth and how we can use it in our applications.</p> <p>Bluetooth technology can be used in a variety of ways, and in this post I am going to focus on how we can make our device broadcast its presence to nearby devices, and also how we can scan for nearby devices that are running our app.</p> <p>In order to implement this app, we are going to use <a href="https://developer.apple.com/documentation/corebluetooth"><code class="language-plaintext highlighter-rouge">Core Bluetooth</code></a>, a framework to communicate between BLE devices provided by Apple.</p> <p>Long story short, in this article, I am going to create a simple app to demonstrate how to use <code class="language-plaintext highlighter-rouge">Core Bluetooth</code> to implement the above mentioned scenario. The app will consists of a <code class="language-plaintext highlighter-rouge">UITextField</code>, where the user will enter the name for the device and two instances of <code class="language-plaintext highlighter-rouge">UIButton</code>. The one button will act as a trigger to start broadcasting, while the other will start the process of scanning other nearby devices.</p> <p><img src="https://diamantidis.github.io/assets/corebluetooth/sample_app.png" alt="Sample app screenshot"></p> <h2 id="implementation">Implementation</h2> <p>Before we dig deeper to the implementation, let’s take a look on some terminology. A BLE(Bluetooth Low Energy) device can be categorized into two roles: <code class="language-plaintext highlighter-rouge">peripheral</code> and <code class="language-plaintext highlighter-rouge">central</code>. A device acting as a peripheral advertises its presence, whereas a device acting as a central listens to these advertising packets. So in our case, we want our application to act both as a peripheral and a central.</p> <p>With separation of concerns in mind, we are going to create a class that will handle the logic of broadcasting and scanning for devices using <code class="language-plaintext highlighter-rouge">CoreBluetooth</code>, and then we will see how we can use this class in a Catalyst application.</p> <p>Before we jump to the actual implementation, let’s take some time to think about the desired behavior of this class and define the corresponding <code class="language-plaintext highlighter-rouge">protocol</code>.</p> <p>First of all, we are going to need two functions that will be responsible for the initialization of the advertising and the scanning process. For the advertising one, we need to pass a <code class="language-plaintext highlighter-rouge">String</code> as a parameter, which is going to be used as the name of our device. Then, we have to somehow notify the uses of this class when a new device is discover. Maybe for this, we can use a delegate with a function that will be called once a new device is found and a hash map to store the peripherals.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">BluetoothManagerDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">peripheralsDidUpdate</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">BluetoothManager</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">peripherals</span><span class="p">:</span> <span class="kt">Dictionary</span><span class="o">&lt;</span><span class="kt">UUID</span><span class="p">,</span> <span class="kt">CBPeripheral</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">BluetoothManagerDelegate</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">startAdvertising</span><span class="p">(</span><span class="n">with</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">startScanning</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now that we have our protocol ready, we can move on to the actual implementation. Let’s create a new class named <code class="language-plaintext highlighter-rouge">CoreBluetoothManager</code>. This class will conform to the <code class="language-plaintext highlighter-rouge">BluetoothManager</code> protocol and will have the following content:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">CoreBluetoothManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">BluetoothManager</span> <span class="p">{</span>
    <span class="c1">// MARK: - Public properties</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">BluetoothManagerDelegate</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">peripherals</span> <span class="o">=</span> <span class="kt">Dictionary</span><span class="o">&lt;</span><span class="kt">UUID</span><span class="p">,</span> <span class="kt">CBPeripheral</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">peripheralsDidUpdate</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// MARK: - Public methods</span>
    <span class="kd">func</span> <span class="nf">startAdvertising</span><span class="p">(</span><span class="n">with</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">peripheralManager</span> <span class="o">=</span> <span class="kt">CBPeripheralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">startScanning</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">centralManager</span> <span class="o">=</span> <span class="kt">CBCentralManager</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// MARK: - Private properties</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">peripheralManager</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">centralManager</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p>Please mind that you have to add <code class="language-plaintext highlighter-rouge">import CoreBluetooth</code> in the beginning of the file.</p> </blockquote> <p>First, we describe the public properties for the <code class="language-plaintext highlighter-rouge">delegate</code> and the <code class="language-plaintext highlighter-rouge">peripherals</code>. When the value of the <code class="language-plaintext highlighter-rouge">peripherals</code> is updated, we call the <code class="language-plaintext highlighter-rouge">peripheralsDidUpdate</code> function to notify the delegate.</p> <p>Then, we define the implementation for the <code class="language-plaintext highlighter-rouge">func startAdvertising(with name: String)</code> requirement. In this function, we initialize an instance of <code class="language-plaintext highlighter-rouge">CBPeripheralManager</code> which we will store in a private property. <code class="language-plaintext highlighter-rouge">CBPeripheralManager</code> is part of the <code class="language-plaintext highlighter-rouge">CoreBluetooth</code> framework and its primary function is to allow us to advertise to other devices.</p> <blockquote> <p>For now the compiler will complain because we have set <code class="language-plaintext highlighter-rouge">self</code> as the delegate and it is not conforming to the <code class="language-plaintext highlighter-rouge">CBPeripheralManagerDelegate</code> protocol. We are going to fix this soon.</p> </blockquote> <p>Moving on, we have the implementation for the <code class="language-plaintext highlighter-rouge">startScanning</code> requirement. In this case we initialize an instance of <code class="language-plaintext highlighter-rouge">CBCentralManager</code> which we also store in a private property. <code class="language-plaintext highlighter-rouge">CBCentralManager</code> is responsible for scanning for nearby BLE devices.</p> <p>Since the compiler is complaining about the delegate, let’s try to implement them. First, let’s add an extension to the <code class="language-plaintext highlighter-rouge">CoreBluetoothManager</code> that will conform to the <code class="language-plaintext highlighter-rouge">CBPeripheralManagerDelegate</code> protocol and add the following content:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">CoreBluetoothManager</span><span class="p">:</span> <span class="kt">CBPeripheralManagerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">peripheralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheralManager</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">isAdvertising</span> <span class="p">{</span>
                <span class="n">peripheral</span><span class="o">.</span><span class="nf">stopAdvertising</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">let</span> <span class="nv">uuid</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">Constants</span><span class="o">.</span><span class="kt">SERVICE_UUID</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
            <span class="k">var</span> <span class="nv">advertisingData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="kt">CBAdvertisementDataServiceUUIDsKey</span><span class="p">:</span> <span class="p">[</span><span class="n">uuid</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">name</span> <span class="p">{</span>
                <span class="n">advertisingData</span><span class="p">[</span><span class="kt">CBAdvertisementDataLocalNameKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="p">}</span>
            <span class="k">self</span><span class="o">.</span><span class="n">peripheralManager</span><span class="p">?</span><span class="o">.</span><span class="nf">startAdvertising</span><span class="p">(</span><span class="n">advertisingData</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cp">#warning("handle other states")</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Here, we provide an implementation for the <code class="language-plaintext highlighter-rouge">peripheralManagerDidUpdateState</code> requirement. In the body of this function we check if the <code class="language-plaintext highlighter-rouge">peripheral.state</code> is <code class="language-plaintext highlighter-rouge">.poweredOn</code> as described on <a href="https://developer.apple.com/documentation/corebluetooth/cbperipheralmanager">Apple’s documentation</a>.</p> <blockquote> <p>Before you call CBPeripheralManager methods, the peripheral manager object must be in the powered-on state, as indicated by the <code class="language-plaintext highlighter-rouge">CBPeripheralManagerState.poweredOn</code>. This state indicates that the device (your iPhone or iPad, for instance) supports Bluetooth low energy and that its Bluetooth is on and available for use.</p> </blockquote> <p>After that, we check if the peripheral is already advertising and if it does, we stop it so that we can start advertising again with the new <code class="language-plaintext highlighter-rouge">advertisingData</code> which we are doing exactly after. <code class="language-plaintext highlighter-rouge">advertisingData</code> is a dictionary that contains the data to advertise. The supported advertising data types are <code class="language-plaintext highlighter-rouge">CBAdvertisementDataServiceUUIDsKey</code> and <code class="language-plaintext highlighter-rouge">CBAdvertisementDataLocalNameKey</code>. The first one is a UUID specific to our application and it will be used to filter out other BLE devices, whereas the second one is the local name of the peripheral.</p> <p>For the service UUID, we add an <code class="language-plaintext highlighter-rouge">enum</code> named <code class="language-plaintext highlighter-rouge">Constants</code>, where we add a case for the <code class="language-plaintext highlighter-rouge">SERVICE_UUID</code>, like in the following snippet</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">Constants</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kt">SERVICE_UUID</span> <span class="o">=</span> <span class="s">"4DF91029-B356-463E-9F48-BAB077BF3EF5"</span>
<span class="p">}</span>
</code></pre></div></div> <p>Finally, we can call the <code class="language-plaintext highlighter-rouge">startAdvertising</code> function to initiate the advertising process.</p> <p>Let’s move now to the scanning part of our class. We are going to add another extension to <code class="language-plaintext highlighter-rouge">CoreBluetoothManager</code> and this time it will conform to the <code class="language-plaintext highlighter-rouge">CBCentralManagerDelegate</code> protocol. The content of this extension will be the following:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">CoreBluetoothManager</span><span class="p">:</span> <span class="kt">CBCentralManagerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">centralManagerDidUpdateState</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">central</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">poweredOn</span> <span class="p">{</span>

            <span class="k">if</span> <span class="n">central</span><span class="o">.</span><span class="n">isScanning</span> <span class="p">{</span>
                <span class="n">central</span><span class="o">.</span><span class="nf">stopScan</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">let</span> <span class="nv">uuid</span> <span class="o">=</span> <span class="kt">CBUUID</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">Constants</span><span class="o">.</span><span class="kt">SERVICE_UUID</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
            <span class="n">central</span><span class="o">.</span><span class="nf">scanForPeripherals</span><span class="p">(</span><span class="nv">withServices</span><span class="p">:</span> <span class="p">[</span><span class="n">uuid</span><span class="p">])</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cp">#warning("Error handling")</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">centralManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">central</span><span class="p">:</span> <span class="kt">CBCentralManager</span><span class="p">,</span> <span class="n">didDiscover</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">CBPeripheral</span><span class="p">,</span> <span class="nv">advertisementData</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">],</span> <span class="n">rssi</span> <span class="kt">RSSI</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">peripherals</span><span class="p">[</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">peripheral</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In the same fashion as with the <code class="language-plaintext highlighter-rouge">CBPeripheralManagerDelegate</code> extension, we satisfy the <code class="language-plaintext highlighter-rouge">centralManagerDidUpdateState</code> requirement for the <code class="language-plaintext highlighter-rouge">CBCentralManager</code> this time, and again we are checking if the <code class="language-plaintext highlighter-rouge">central.state</code> is <code class="language-plaintext highlighter-rouge">.poweredOn</code> and if it is already scanning then we call the <code class="language-plaintext highlighter-rouge">stopScan</code>. Finally, we call <code class="language-plaintext highlighter-rouge">scanForPeripherals</code> and pass the <code class="language-plaintext highlighter-rouge">CBUUID</code> with the <code class="language-plaintext highlighter-rouge">SERVICE_UUID</code> that we are using for our application. This way, we are going to scan for devices that advertise this service and ignore all the others.</p> <p>After starting the scanning process, we have to get informed when a device is discovered and for this reason, we add an implementation for the <code class="language-plaintext highlighter-rouge">didDiscover</code> requirement of the <code class="language-plaintext highlighter-rouge">CBCentralManagerDelegate</code>. There, we just update the peripherals dictionary with the peripheral that we have just discovered.</p> <p>And that’s it regarding the <code class="language-plaintext highlighter-rouge">BluetoothManager</code>. Let’s now move on and see how we can use this class.</p> <h2 id="application">Application</h2> <p>As mentioned in the introduction, the application will have one screen which will contain a <code class="language-plaintext highlighter-rouge">UITextField</code> to enter the device name that we will use when calling the <code class="language-plaintext highlighter-rouge">startAdvertising</code>, and two instances of <code class="language-plaintext highlighter-rouge">UIButton</code>, one for triggering the advertising process and one for triggering the scanning process.</p> <p>Since the post is about <code class="language-plaintext highlighter-rouge">Core Bluetooth</code> I will focus on how to use the class <code class="language-plaintext highlighter-rouge">CoreBluetoothManager</code> that we have just created and skip the UI part. The UI is created with UIKit, AutoLayout and programmatic views. Furthermore, the whole code can be found on <a href="https://github.com/diamantidis/DemoBluetooth/tree/93f64c32">GitHub</a> and it’s a Catalyst application, meaning you can run it on iPhone, iPad or Mac.</p> <p>To use the <code class="language-plaintext highlighter-rouge">CoreBluetoothManager</code>, we instantiate an instance of it in the <code class="language-plaintext highlighter-rouge">SceneDelegate</code> and we inject it to our only <code class="language-plaintext highlighter-rouge">UIViewController</code>, the <code class="language-plaintext highlighter-rouge">BluetoothViewController</code>.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SceneDelegate.swift</span>

<span class="kd">class</span> <span class="kt">SceneDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span><span class="p">,</span> <span class="kt">UIWindowSceneDelegate</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">bluetoothManager</span> <span class="o">=</span> <span class="kt">CoreBluetoothManager</span><span class="p">()</span>
    <span class="o">.</span>
    <span class="o">.</span> 
    <span class="o">.</span> 


    <span class="kd">func</span> <span class="nf">scene</span><span class="p">(</span><span class="n">_</span> <span class="nv">scene</span><span class="p">:</span> <span class="kt">UIScene</span><span class="p">,</span> <span class="n">willConnectTo</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">UISceneSession</span><span class="p">,</span> <span class="n">options</span> <span class="nv">connectionOptions</span><span class="p">:</span> <span class="kt">UIScene</span><span class="o">.</span><span class="kt">ConnectionOptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">.</span>
        <span class="o">.</span> 
        <span class="o">.</span> 
        <span class="k">let</span> <span class="nv">vc</span> <span class="o">=</span> <span class="kt">BluetoothViewController</span><span class="p">(</span><span class="nv">bluetoothManager</span><span class="p">:</span> <span class="n">bluetoothManager</span><span class="p">)</span>
        <span class="o">.</span>
        <span class="o">.</span> 
        <span class="o">.</span> 
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div> <p>In the <code class="language-plaintext highlighter-rouge">BluetoothViewController</code>, we receive an instance of a class that conforms to the protocol <code class="language-plaintext highlighter-rouge">BluetoothManager</code> in the init function and we store it in a private property.</p> <p>Then, we provide the implementations for the two buttons. For the first one, we use the <code class="language-plaintext highlighter-rouge">bluetoothManager</code> to call the <code class="language-plaintext highlighter-rouge">startAdvertising</code> and we pass the value of the <code class="language-plaintext highlighter-rouge">UITextField</code> as the device name. For the second button, we set the <code class="language-plaintext highlighter-rouge">delegate</code> of the <code class="language-plaintext highlighter-rouge">bluetoothManager</code> to <code class="language-plaintext highlighter-rouge">self</code> and call the <code class="language-plaintext highlighter-rouge">startScanning</code> function to trigger the scanning process.</p> <p>As a result, we have to make <code class="language-plaintext highlighter-rouge">BluetoothViewController</code> conform to the protocol <code class="language-plaintext highlighter-rouge">BluetoothManagerDelegate</code>, by adding an extension and providing an implementation of the method <code class="language-plaintext highlighter-rouge">peripheralsDidUpdate</code> to fulfill <code class="language-plaintext highlighter-rouge">BluetoothManagerDelegate</code>’s requirement. In this function, we just print the names of the peripherals on the console, but we could potentially reload an instance of a <code class="language-plaintext highlighter-rouge">UITableView</code> that would present the nearby devices.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// BluetoothViewController.swift</span>

<span class="kd">class</span> <span class="kt">BluetoothViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">bluetoothManager</span><span class="p">:</span> <span class="kt">BluetoothManager</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">bluetoothManager</span> <span class="o">=</span> <span class="n">bluetoothManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">nibName</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">bundle</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">bluetoothManager</span><span class="p">:</span> <span class="kt">BluetoothManager</span>

    <span class="kd">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startAdvertising</span><span class="p">(</span><span class="nv">sender</span><span class="p">:</span> <span class="kt">UIButton</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">nameTextField</span><span class="o">.</span><span class="nf">resignFirstResponder</span><span class="p">()</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>

        <span class="n">bluetoothManager</span><span class="o">.</span><span class="nf">startAdvertising</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">@objc</span> <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startScanning</span><span class="p">(</span><span class="nv">sender</span><span class="p">:</span> <span class="kt">UIButton</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bluetoothManager</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">bluetoothManager</span><span class="o">.</span><span class="nf">startScanning</span><span class="p">()</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">BluetoothViewController</span><span class="p">:</span> <span class="kt">BluetoothManagerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">peripheralsDidUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">bluetoothManager</span><span class="o">.</span><span class="n">peripherals</span><span class="o">.</span><span class="n">mapValues</span><span class="p">{</span><span class="nv">$0</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div> <p>And that’s about it for the application code. But before we run the application, we have to make some further adjustments, to enable the usage of Bluetooth.</p> <p>First, we have to add an entry for the key <code class="language-plaintext highlighter-rouge">NSBluetoothAlwaysUsageDescription</code> to our <code class="language-plaintext highlighter-rouge">Info.plist</code> file, like in the following snippet</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;key&gt;NSBluetoothAlwaysUsageDescription&lt;/key&gt;
    &lt;string&gt;Our app uses Bluetooth to find other devices&lt;/string&gt;
</code></pre></div></div> <p>Then, we have to select the target of the app, go to <code class="language-plaintext highlighter-rouge">Signing &amp; Capabilities</code> &gt; <code class="language-plaintext highlighter-rouge">App Sandbox</code> and enable the <code class="language-plaintext highlighter-rouge">Bluetooth</code> checkbox.</p> <p><img src="https://diamantidis.github.io/assets/corebluetooth/bluetooth_sandbox.png" alt="Bluetooth sandbox screenshot"></p> <p>Lastly, make sure to enable the Bluetooth on the device that you are running the application. <img class="emoji" title=":smirk:" alt=":smirk:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60f.png" height="20" width="20"></p> <p>Now our app is ready!! Feel free to run it and start advertising and scanning for nearby devices! <img class="emoji" title=":rocket:" alt=":rocket:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f680.png" height="20" width="20"></p> <h2 id="conclusion">Conclusion</h2> <p>In this post, we have seen how to use the <code class="language-plaintext highlighter-rouge">CoreBluetooth</code> framework to advertise that an application is running on a device and also scan for nearby devices that are running the application. These concepts can be used as a base and build more complex application that will rely on Bluetooth and the communication of nearby devices, like for example a chat app, or maybe an AirDrop-like solution to share documents with other non-Apple devices.</p> <p>Thanks for reading, I hope you find this post useful! Feel free to find me on <a href="https://twitter.com/diamantidis_io">Twitter</a> and share your comments about this post!</p> </div> <div class="socials"> <!-- Buy me a coffee button --> <a href="https://www.buymeacoffee.com/diamantidis" target="_blank"> <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"> </a> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=Scan+and+broadcast+to+nearby+devices+with+Core+Bluetooth&amp;url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F16%2Fbroadcast-and-scan-nearby-devices-using-corebluetooth" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=Scan+and+broadcast+to+nearby+devices+with+Core+Bluetooth&amp;u=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F16%2Fbroadcast-and-scan-nearby-devices-using-corebluetooth" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F16%2Fbroadcast-and-scan-nearby-devices-using-corebluetooth" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </div></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> © Copyright 2024 Ioannis Diamantidis </p> </div> </footer></body> </html>
