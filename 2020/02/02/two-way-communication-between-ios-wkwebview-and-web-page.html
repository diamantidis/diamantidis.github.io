<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>Two-way communication between an iOS WKWebView and a web page</title><!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="Two-way communication between an iOS WKWebView and a web page" /> <meta name="author" content="Ioannis Diamantidis" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A post about how to use Swift and JavaScript to communicate between the iOS WKWebView and the website" /> <meta property="og:description" content="A post about how to use Swift and JavaScript to communicate between the iOS WKWebView and the website" /> <link rel="canonical" href="https://diamantidis.github.io/2020/02/02/two-way-communication-between-ios-wkwebview-and-web-page" /> <meta property="og:url" content="https://diamantidis.github.io/2020/02/02/two-way-communication-between-ios-wkwebview-and-web-page" /> <meta property="og:site_name" content="Ioannis Diamantidis" /> <meta property="og:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-02-02T04:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:image" content="https://diamantidis.github.io/assets/socialIcon.png" /> <meta property="twitter:title" content="Two-way communication between an iOS WKWebView and a web page" /> <meta name="twitter:site" content="@diamantidis_io" /> <meta name="twitter:creator" content="@diamantidis_io" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ioannis Diamantidis","url":"https://diamantidis.github.io"},"dateModified":"2020-02-02T04:00:00+00:00","datePublished":"2020-02-02T04:00:00+00:00","description":"A post about how to use Swift and JavaScript to communicate between the iOS WKWebView and the website","headline":"Two-way communication between an iOS WKWebView and a web page","image":"https://diamantidis.github.io/assets/socialIcon.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://diamantidis.github.io/2020/02/02/two-way-communication-between-ios-wkwebview-and-web-page"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://diamantidis.github.io/assets/socialIcon.png"},"name":"Ioannis Diamantidis"},"url":"https://diamantidis.github.io/2020/02/02/two-way-communication-between-ios-wkwebview-and-web-page"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"><!-- Buy me a coffee widget --> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="diamantidis" data-description="Support me on Buy me a coffee!" data-message="" data-color="#347ab7" data-position="Right" data-x_margin="18" data-y_margin="18"></script> <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://diamantidis.github.io/feed.xml" title="Ioannis Diamantidis" /><script src="https://cdn.telemetrydeck.com/websdk/telemetrydeck.min.js" data-app-id='38585865-E115-4830-8D37-7A8F1213DC6B' ></script> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_sTVQpj2y4ME7gaB3ETrOfwqd4B78MrA2ixW11xju0Hg',{api_host:'https://eu.posthog.com'}) </script></head> <body><header class="site-header" role="banner"> <div class="wrapper"><div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Ioannis Diamantidis</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div><nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger" /> <label for="nav-trigger"> <span class="menu-icon"> <svg viewBox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" /> </svg> </span> </label> <div class="trigger"> <a class="page-link" href="/tips" title="Tips">Tips</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a></div> </nav></div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title break-long-word">Two-way communication between an iOS WKWebView and a web page</span> </h1> <div class="post-subheader"> <span class="post-date"> February 2, 2020 </span> <span class="post-divider">-</span> <span class="post-minutes"> 9 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#iOS" title="iOS">iOS</a> <a class="post-tag" href="/tags#Swift" title="Swift">Swift</a> <a class="post-tag" href="/tags#WKWebview" title="WKWebview">WKWebview</a> <a class="post-tag" href="/tags#JavaScript" title="JavaScript">JavaScript</a> </div> </div> </div> </header> <div class="post-content"> <p>Sometimes, on a native iOS app, there is the need to embed a web page within the application. To cater for cases like this, <code class="language-plaintext highlighter-rouge">iOS</code> provides <code class="language-plaintext highlighter-rouge">WKWebView</code>, an object that allows us to display web content in apps. <code class="language-plaintext highlighter-rouge">WKWebView</code> makes it easy and quite straightforward to load a web page, but what happens when we want to open a communication channel between the app and the web-page?</p> <p>In this post I will show how to use Swift and JavaScript to communicate between the app and the web-page that is loaded on the <code class="language-plaintext highlighter-rouge">WKWebView</code>.</p> <p>In order to do so, I am going to use an example to demonstrate how to achieve communication in both directions; both from the web page to the app and from the app to the web-page.</p> <p>Let’s get started!</p> <h2 id="implementation">Implementation</h2> <h3 id="the-html-file">The HTML file</h3> <p>For the sake of this article and for ease, instead of loading a URL, I am going to add an HTML file on the project and load that on the WKWebView. If you still want to use a URL, the process remains the same, with the only difference being that you need to load a URLRequest instead of a fileURL on the <code class="language-plaintext highlighter-rouge">WKWebView</code>.</p> <p>Let’s create the HTML file, name it <code class="language-plaintext highlighter-rouge">index.html</code> and add the following content:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;style&gt;</span>
            <span class="nc">.switch</span> <span class="p">{</span> <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span> <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">60px</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span> <span class="m">34px</span><span class="p">;</span> <span class="p">}</span>
            <span class="nc">.switch</span> <span class="nt">input</span> <span class="p">{</span> <span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
            <span class="nt">label</span><span class="nc">.switch</span> <span class="p">{</span> <span class="nl">outline</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span> <span class="p">}</span>
            <span class="nc">.slider</span> <span class="p">{</span> <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span> <span class="nl">cursor</span><span class="p">:</span> <span class="nb">pointer</span><span class="p">;</span> <span class="nl">top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">right</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span> <span class="nl">background-color</span><span class="p">:</span> <span class="m">#ccc</span><span class="p">;</span> <span class="nl">-webkit-transition</span><span class="p">:</span> <span class="m">.4s</span><span class="p">;</span> <span class="nl">transition</span><span class="p">:</span> <span class="m">.4s</span><span class="p">;</span> <span class="nl">outline</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span> <span class="p">}</span>
            <span class="nc">.slider</span><span class="nd">:before</span> <span class="p">{</span> <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">""</span><span class="p">;</span> <span class="nl">height</span><span class="p">:</span> <span class="m">26px</span><span class="p">;</span> <span class="nl">width</span><span class="p">:</span> <span class="m">26px</span><span class="p">;</span> <span class="nl">left</span><span class="p">:</span> <span class="m">4px</span><span class="p">;</span> <span class="nl">bottom</span><span class="p">:</span> <span class="m">4px</span><span class="p">;</span> <span class="nl">background-color</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span> <span class="nl">-webkit-transition</span><span class="p">:</span> <span class="m">.4s</span><span class="p">;</span> <span class="nl">transition</span><span class="p">:</span> <span class="m">.4s</span><span class="p">;</span> <span class="p">}</span>
            <span class="nt">input</span><span class="nd">:checked</span> <span class="o">+</span> <span class="nc">.slider</span> <span class="p">{</span> <span class="nl">background-color</span><span class="p">:</span> <span class="m">#2196F3</span><span class="p">;</span> <span class="p">}</span>
            <span class="nt">input</span><span class="nd">:focus</span> <span class="o">+</span> <span class="nc">.slider</span> <span class="p">{</span> <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1px</span> <span class="m">#2196F3</span><span class="p">;</span> <span class="p">}</span>
            <span class="nt">input</span><span class="nd">:checked</span> <span class="o">+</span> <span class="nc">.slider</span><span class="nd">:before</span> <span class="p">{</span> <span class="nl">-webkit-transform</span><span class="p">:</span> <span class="n">translateX</span><span class="p">(</span><span class="m">26px</span><span class="p">);</span> <span class="nl">-ms-transform</span><span class="p">:</span> <span class="n">translateX</span><span class="p">(</span><span class="m">26px</span><span class="p">);</span> <span class="nl">transform</span><span class="p">:</span> <span class="n">translateX</span><span class="p">(</span><span class="m">26px</span><span class="p">);</span> <span class="p">}</span>
            <span class="nc">.slider.round</span> <span class="p">{</span> <span class="nl">border-radius</span><span class="p">:</span> <span class="m">34px</span><span class="p">;</span> <span class="p">}</span>
            <span class="nc">.slider.round</span><span class="nd">:before</span> <span class="p">{</span> <span class="nl">border-radius</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span> <span class="p">}</span>
        <span class="nt">&lt;/style&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"value"</span><span class="nt">&gt;</span>Toggle Switch is off<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"switch"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">name=</span><span class="s">"myCheckbox"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"slider round"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div> <blockquote> <p>For brevity reasons, the CSS part is minimized.</p> </blockquote> <p>This HTML produces a web page with a label and a toggle switch. Our goal is to listen to the toggle events and update the text on the label to represent the corresponding state of the toggle switch.</p> <h3 id="adding-the-wkwebview">Adding the WKWebView</h3> <p>To start with, we are going to add an instance of a WKWebView to a <code class="language-plaintext highlighter-rouge">UIViewController</code> and load the HTML file that we created earlier.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">WebKit</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

        <span class="n">view</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">webView</span><span class="p">)</span>
        <span class="kt">NSLayoutConstraint</span><span class="o">.</span><span class="nf">activate</span><span class="p">([</span>
            <span class="n">webView</span><span class="o">.</span><span class="n">leadingAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">leadingAnchor</span><span class="p">),</span>
            <span class="n">webView</span><span class="o">.</span><span class="n">trailingAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">trailingAnchor</span><span class="p">),</span>
            <span class="n">webView</span><span class="o">.</span><span class="n">bottomAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">layoutMarginsGuide</span><span class="o">.</span><span class="n">bottomAnchor</span><span class="p">),</span>
            <span class="n">webView</span><span class="o">.</span><span class="n">topAnchor</span><span class="o">.</span><span class="nf">constraint</span><span class="p">(</span><span class="nv">equalTo</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">layoutMarginsGuide</span><span class="o">.</span><span class="n">topAnchor</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">url</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="s">"index"</span><span class="p">,</span> <span class="nv">withExtension</span><span class="p">:</span> <span class="s">"html"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">webView</span><span class="o">.</span><span class="nf">loadFileURL</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nv">allowingReadAccessTo</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="nf">deletingLastPathComponent</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">webView</span> <span class="o">=</span> <span class="kt">WKWebView</span><span class="p">()</span>
        <span class="n">webView</span><span class="o">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="k">return</span> <span class="n">webView</span>
    <span class="p">}()</span>
<span class="p">}</span>
</code></pre></div></div> <p>Quite self-descriptive, we create a private instance of a <code class="language-plaintext highlighter-rouge">WKWebView</code>, we add it as a subview to the <code class="language-plaintext highlighter-rouge">ViewController</code>’s view, add the required <code class="language-plaintext highlighter-rouge">AutoLayout</code> constraints and then load the file.</p> <p>Try to run the app, and you will see the page with the label and toggle, loaded in your <code class="language-plaintext highlighter-rouge">WKWebView</code> like in the following screenshot:</p> <p><img src="https://diamantidis.github.io/assets/wkwebview/toggle_off.png" alt="WKWebView with a toggle screenshot" /></p> <h3 id="adding-the-message-handler">Adding the message handler</h3> <p>The next step is to enable our <code class="language-plaintext highlighter-rouge">WKWebView</code> to receive messages from the web-page and to accomplish that, we will make our <code class="language-plaintext highlighter-rouge">UIViewController</code> conform to the <code class="language-plaintext highlighter-rouge">WKScriptMessageHandler</code> protocol.</p> <p>According to the <a href="https://developer.apple.com/documentation/webkit/wkscriptmessagehandler">documentation</a>:</p> <blockquote> <p>A class conforming to the <code class="language-plaintext highlighter-rouge">WKScriptMessageHandler</code> protocol provides a method for receiving messages from JavaScript running in a webpage.</p> </blockquote> <p>This protocol requires the definition of the function <code class="language-plaintext highlighter-rouge">userContentController(_: didReceive:)</code>, so let’s add an extension to our ViewController class, add conformance to the <code class="language-plaintext highlighter-rouge">WKScriptMessageHandler</code> protocol and provide an implementation for this function.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">WKScriptMessageHandler</span><span class="p">{</span>
    <span class="kd">func</span> <span class="nf">userContentController</span><span class="p">(</span><span class="n">_</span> <span class="nv">userContentController</span><span class="p">:</span> <span class="kt">WKUserContentController</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">WKScriptMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">dict</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nf">print</span><span class="p">(</span><span class="n">dict</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>For now, we are assuming that the message sent from the web-page will be a dictionary, so we just transforming the body of a message to a dictionary and print the result.</p> <p>After that, we have to make our <code class="language-plaintext highlighter-rouge">WKWebView</code> aware of this message handler. This can be done by adding this script message handler to the user content controller of the WKWebView.</p> <p>According to the documentation:</p> <blockquote> <p>A <code class="language-plaintext highlighter-rouge">WKUserContentController</code> object provides a way for JavaScript to post messages to a web view. The user content controller associated with a web view is specified by its web view configuration.</p> </blockquote> <p>Let’s add the following lines directly after the <code class="language-plaintext highlighter-rouge">AutoLayout</code> constraints on the <code class="language-plaintext highlighter-rouge">viewDidLoad</code> function.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">contentController</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">userContentController</span>
<span class="n">contentController</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="s">"toggleMessageHandler"</span><span class="p">)</span>
</code></pre></div></div> <p>In this snippet, we are accessing the <code class="language-plaintext highlighter-rouge">userContentController</code> of the web view and then call the <code class="language-plaintext highlighter-rouge">add</code> function, providing the instance of a class conforming to the <code class="language-plaintext highlighter-rouge">WKScriptMessageHandler</code> (in our case the <code class="language-plaintext highlighter-rouge">ViewController</code>’s instance), and a name, which we later use on the web-page to send the messages to the app.</p> <p>Now, we are ready to send our messages from the web page.</p> <p>Let’s see how!</p> <h3 id="sending-message-from-the-webpage">Sending message from the webpage</h3> <p>For this part, we are going to use some JavaScript to listen to the toggle events and then send a message to the app. This message will reflect if the toggle is selected or not. Let’s edit our HTML file and before the closing <code class="language-plaintext highlighter-rouge">&lt;/body&gt;</code> tag, let’s add the following content:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">_selector</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">input[name=myCheckbox]</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">_selector</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_selector</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">Toggle Switch is on</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Toggle Switch is off</span><span class="dl">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">toggleMessageHandler</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">toggleMessageHandler</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span>
                <span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span> <span class="nx">message</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <p>In this script, we are adding an eventListener for the toggle change event, and depending on whether it is selected or not, we are using the <code class="language-plaintext highlighter-rouge">messageHandler</code> with name <code class="language-plaintext highlighter-rouge">toggleMessageHandler</code> that we created previously, to call the function <code class="language-plaintext highlighter-rouge">postMessage</code> which in turn will trigger the <code class="language-plaintext highlighter-rouge">userContentController(_: didReceive:)</code>.</p> <p>If you run the app and turn the toggle on and off, you will be able to see some messages on the console like <code class="language-plaintext highlighter-rouge">["message": Toggle Switch is on]</code>.</p> <p>So far so good, but what happens if we don’t have access to the web-page to add the JavaScript snippet and we still want to receive the message? Fortunately, we can inject some JavaScript code to a web-page that we load on a <code class="language-plaintext highlighter-rouge">WKWebView</code>!</p> <h3 id="injecting-javascript">Injecting JavaScript</h3> <p>Let’s start by removing the JavaScript code that we added on the HTML. Next, open the <code class="language-plaintext highlighter-rouge">ViewController</code> again, and add the following snippet after the <code class="language-plaintext highlighter-rouge">contentController.add(self, name: "toggleMessageHandler")</code> line.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">js</span> <span class="o">=</span> <span class="s">"""
    var _selector = document.querySelector('input[name=myCheckbox]');
    _selector.addEventListener('change', function(event) {
        var message = (_selector.checked) ? "</span><span class="kt">Toggle</span> <span class="kt">Switch</span> <span class="k">is</span> <span class="n">on</span><span class="s">" : "</span><span class="kt">Toggle</span> <span class="kt">Switch</span> <span class="k">is</span> <span class="n">off</span><span class="s">";
        if (window.webkit &amp;&amp; window.webkit.messageHandlers &amp;&amp; window.webkit.messageHandlers.toggleMessageHandler) {
            window.webkit.messageHandlers.toggleMessageHandler.postMessage({
                "</span><span class="n">message</span><span class="s">": message
            });
        }
    });
"""</span>

<span class="k">let</span> <span class="nv">script</span> <span class="o">=</span> <span class="kt">WKUserScript</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="n">js</span><span class="p">,</span> <span class="nv">injectionTime</span><span class="p">:</span> <span class="o">.</span><span class="n">atDocumentEnd</span><span class="p">,</span> <span class="nv">forMainFrameOnly</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="n">contentController</span><span class="o">.</span><span class="nf">addUserScript</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
</code></pre></div></div> <p>In this snippet, firstly we create a string variable with the JavaScript code that listens to the toggle events and sends the message to the messageHandler. Then, we are creating an instance of <code class="language-plaintext highlighter-rouge">WKUserScript</code> with this code as a source, and finally we inject it to the <code class="language-plaintext highlighter-rouge">WKWebView</code> by adding it to the <code class="language-plaintext highlighter-rouge">contentController</code> that we also used earlier.</p> <p>If you run the app again, you will notice the same behavior as before.</p> <p>Last thing to achieve our goal, is to update the webpage.</p> <h3 id="evaluating-javascript-to-update-webpages-ui">Evaluating JavaScript to update webpage’s UI</h3> <p><code class="language-plaintext highlighter-rouge">WKWebView</code> provides a function to evaluate JavaScript code and this is what we are going to use to update the UI.</p> <p>Head over to the function <code class="language-plaintext highlighter-rouge">userContentController(_: didReceive:)</code> that we defined on our extension and instead of the print command, add the following snippet:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">guard</span> <span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">dict</span><span class="p">[</span><span class="s">"message"</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">script</span> <span class="o">=</span> <span class="s">"document.getElementById('value').innerText = </span><span class="se">\"\(</span><span class="n">message</span><span class="se">)\"</span><span class="s">"</span>

<span class="n">webView</span><span class="o">.</span><span class="nf">evaluateJavaScript</span><span class="p">(</span><span class="n">script</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">result</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Label is updated with message: </span><span class="se">\(</span><span class="n">result</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this snippet, we are accessing the value of <code class="language-plaintext highlighter-rouge">message</code> key from the dictionary, create a variable with the JavaScript code to change the label on the web-page, and then use the <code class="language-plaintext highlighter-rouge">evaluateJavaScript</code> to execute this code. <code class="language-plaintext highlighter-rouge">evaluateJavaScript</code> takes a closure as a second argument to check if there was an error during the evaluation of the JavaScript code.</p> <p>And that’s about it, if you now run the app, the text of the label will change when the toggle is switched on or off.</p> <p><img src="https://diamantidis.github.io/assets/wkwebview/toggle_animation.gif" alt="WebView with toggle on and off screenshot" /></p> <h2 id="insight">Insight</h2> <p>In this post, we have seen how to achieve bidirectional communication between a WKWebView and the website it loaded. Using this, we can use events from the website to trigger actions on the app and similarly adjust the loaded website based on the information we have on the app.</p> <p>Thanks for reading, I hope you find this post useful! Feel free to follow me on <a href="https://twitter.com/diamantidis_io">Twitter</a> and share your comments about this post!</p> </div> <div class="socials"> <!-- Buy me a coffee button --> <a href="https://www.buymeacoffee.com/diamantidis" target="_blank"> <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" > </a> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=Two-way+communication+between+an+iOS+WKWebView+and+a+web+page&url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F02%2Ftwo-way-communication-between-ios-wkwebview-and-web-page" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=Two-way+communication+between+an+iOS+WKWebView+and+a+web+page&u=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F02%2Ftwo-way-communication-between-ios-wkwebview-and-web-page" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F02%2F02%2Ftwo-way-communication-between-ios-wkwebview-and-web-page" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </div></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> © Copyright 2024 Ioannis Diamantidis </p> </div> </footer></body> </html>
