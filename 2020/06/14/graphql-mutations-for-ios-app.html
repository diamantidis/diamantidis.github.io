<!DOCTYPE html> <html lang="en"><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"><title>GraphQL mutations for iOS apps (with the help of Combine's Future)</title><!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="GraphQL mutations for iOS apps (with the help of Combine‚Äôs Future)" /> <meta name="author" content="Ioannis Diamantidis" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A guide on how to perform GraphQL mutations on an iOS app built with Swift using Combine‚Äôs Future and Promises" /> <meta property="og:description" content="A guide on how to perform GraphQL mutations on an iOS app built with Swift using Combine‚Äôs Future and Promises" /> <link rel="canonical" href="https://diamantidis.github.io/2020/06/14/graphql-mutations-for-ios-app" /> <meta property="og:url" content="https://diamantidis.github.io/2020/06/14/graphql-mutations-for-ios-app" /> <meta property="og:site_name" content="Ioannis Diamantidis" /> <meta property="og:image" content="https://diamantidis.github.io/assets/social/graphql-mutations-for-ios-apps.png" /> <meta property="og:image:height" content="512" /> <meta property="og:image:width" content="863" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-06-14T04:00:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://diamantidis.github.io/assets/social/graphql-mutations-for-ios-apps.png" /> <meta property="twitter:title" content="GraphQL mutations for iOS apps (with the help of Combine‚Äôs Future)" /> <meta name="twitter:site" content="@diamantidis_io" /> <meta name="twitter:creator" content="@diamantidis_io" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ioannis Diamantidis","url":"https://diamantidis.github.io"},"dateModified":"2020-06-14T04:00:00+00:00","datePublished":"2020-06-14T04:00:00+00:00","description":"A guide on how to perform GraphQL mutations on an iOS app built with Swift using Combine‚Äôs Future and Promises","headline":"GraphQL mutations for iOS apps (with the help of Combine‚Äôs Future)","image":{"width":863,"height":512,"url":"https://diamantidis.github.io/assets/social/graphql-mutations-for-ios-apps.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diamantidis.github.io/2020/06/14/graphql-mutations-for-ios-app"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://diamantidis.github.io/assets/socialIcon.png"},"name":"Ioannis Diamantidis"},"url":"https://diamantidis.github.io/2020/06/14/graphql-mutations-for-ios-app"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/assets/main.css"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.png"/> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="mask-icon" href="assets/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/browserconfig.xml"> <meta name="theme-color" content="#ffffff"><!-- Buy me a coffee widget --> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="diamantidis" data-description="Support me on Buy me a coffee!" data-message="" data-color="#347ab7" data-position="Right" data-x_margin="18" data-y_margin="18"></script> <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://diamantidis.github.io/feed.xml" title="Ioannis Diamantidis" /><script src="https://cdn.telemetrydeck.com/websdk/telemetrydeck.min.js" data-app-id='38585865-E115-4830-8D37-7A8F1213DC6B' ></script> <script> !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_sTVQpj2y4ME7gaB3ETrOfwqd4B78MrA2ixW11xju0Hg',{api_host:'https://eu.posthog.com'}) </script></head> <body><header class="site-header" role="banner"> <div class="wrapper"><div class="left-container"> <div class="title-wrapper"> <a class="site-title" rel="author" href="/"> <h1>Ioannis Diamantidis</h1> </a> </div> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-sm"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> </div><nav class="site-nav"> <input type="checkbox" id="nav-trigger" class="nav-trigger" /> <label for="nav-trigger"> <span class="menu-icon"> <svg viewBox="0 0 18 15" width="18px" height="15px"> <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" /> </svg> </span> </label> <div class="trigger"> <a class="page-link" href="/tips" title="Tips">Tips</a><a class="page-link" href="/about" title="About">About</a><a class="page-link" href="/archive" title="Archive">Archive</a><a class="page-link" href="/tags" title="Tags">Tags</a></div> </nav></div> </header><main class="page-content" aria-label="Content"> <div class="wrapper"> <article class="post"> <header class="post-header"> <h1> <span class="post-title break-long-word">GraphQL mutations for iOS apps (with the help of Combine&#39;s Future)</span> </h1> <div class="post-subheader"> <span class="post-date"> June 14, 2020 </span> <span class="post-divider">-</span> <span class="post-minutes"> 11 min read </span> <div class="outer-post-tags"> <div class="post-tags"> <a class="post-tag" href="/tags#Swift" title="Swift">Swift</a> <a class="post-tag" href="/tags#GraphQL" title="GraphQL">GraphQL</a> <a class="post-tag" href="/tags#iOS" title="iOS">iOS</a> </div> </div> </div> </header> <div class="post-content"> <p>Nowadays, more and more apps rely on a server to support their functionality. One part of this communication is the ability of the app to create new and modify existing data stored on the server.</p> <p>In GraphQL terms, this can be accomplished with the so-called <code class="language-plaintext highlighter-rouge">Mutations</code>. GraphQL uses the term <code class="language-plaintext highlighter-rouge">Mutations</code> to distinguish the queries that will result in some kind of side-effect on the server-side data, from the normal queries that we are using to just fetch data.</p> <p>Long story short, in this post, we are going to see how we can perform GraphQL mutations from an iOS app using the <a href="https://www.apollographql.com/docs/ios/">Apollo iOS client</a> and with a little help from <a href="https://developer.apple.com/documentation/combine/future">Combine‚Äôs Future</a>.</p> <p>The scenario that we want to accomplish is quite simple. First, we are going to fetch some data from the server and then we are going to create a new entry. Once it is created, we will update it and finally delete it.</p> <h2 id="prerequisites">Prerequisites</h2> <p>This post is a continuation of a series of posts about GraphQL and Swift. In the previous posts, we have seen <a href="/2020/05/24/swift-loves-graphql-server-with-vapor-and-ios-app-client">how to setup an iOS project to fetch</a> and <a href="/2020/05/31/custom-graphql-types-on-swift-projects">decode data from a GraphQL server</a>. This time we will see how to modify server-side data using GraphQL‚Äôs mutations.</p> <p>For the server, we are going to use a GraphQL server built with the Vapor framework. The project, along with instructions on how to set it up, is available on <a href="https://github.com/diamantidis/vapor-graphql">GitHub</a> or you can refer to the previous posts to learn more on <a href="/2020/05/24/swift-loves-graphql-server-with-vapor-and-ios-app-client">how to setup</a>, <a href="/2020/05/31/custom-graphql-types-on-swift-projects">add fields with custom types</a> and <a href="/2020/06/07/mutations-on-a-graphql-server-built-with-vapor">add mutations</a>.</p> <p>Also, the iOS project will be based on the project we have built on the previous posts. This project and the instructions on how to set it up are also available on <a href="https://github.com/diamantidis/ios-graphql">GitHub</a>.</p> <p>In those previous posts, I was using a model representing a post and I will continue doing so on this post as well.</p> <h2 id="a-future-and-promise-primer">A Future and Promise Primer</h2> <p>As I mentioned before, we are going to use <a href="https://developer.apple.com/documentation/combine/future">Combine‚Äôs Future</a>.</p> <p>Future was introduced on iOS 13 and is a <code class="language-plaintext highlighter-rouge">Publisher</code> that represents the result of an asynchronous operation. Practically, it will generate a single value or an error and then it will finish.</p> <p>Future is defined as a generic with two types, one for the type of the value and one for the type of the error. Its initializer takes a single argument, which is a closure of type <code class="language-plaintext highlighter-rouge">(Promise) -&gt; Void</code>.</p> <p>As you can see, the closure has an argument of type <code class="language-plaintext highlighter-rouge">Promise</code>. <code class="language-plaintext highlighter-rouge">Promise</code> itself is a closure that takes a <code class="language-plaintext highlighter-rouge">Result</code> as a single parameter and is defined as a typealias for <code class="language-plaintext highlighter-rouge">(Result&lt;Output, Failure&gt;) -&gt; Void</code>.</p> <p>Inside Future‚Äôs closure, we are using the instance of <code class="language-plaintext highlighter-rouge">Promise</code> and pass either <code class="language-plaintext highlighter-rouge">.success</code> or <code class="language-plaintext highlighter-rouge">.failure</code> as a parameter to determine if the asynchronous operation was successful or not.</p> <p>Let‚Äôs see a simple example:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">AppError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">random</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">future</span> <span class="o">=</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">AppError</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">promise</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kc">true</span> <span class="p">{</span>
        <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="s">"üéâ"</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="kt">AppError</span><span class="o">.</span><span class="n">random</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this example, our Future can either generate a <code class="language-plaintext highlighter-rouge">String</code> value or it will fail with an error of type <code class="language-plaintext highlighter-rouge">AppError</code>. Then, inside the closure, we are passing the result to the promise closure.</p> <p>And that‚Äôs brief intro to Combine‚Äôs Future. Let‚Äôs now jump to the GraphQL mutations!</p> <h2 id="implementation">Implementation</h2> <p>Having setup the project as it was at the end of the <a href="/2020/05/31/custom-graphql-types-on-swift-projects">previous post</a>, we will have to update the schema to fetch the definitions for the mutations.</p> <p>With the server running, run the following command from the root directory of the iOS project to update the <code class="language-plaintext highlighter-rouge">schema.json</code>.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apollo schema:download <span class="nt">--endpoint</span><span class="o">=</span>http://127.0.0.1:8080/graphql iOSGraphQL/GraphQL/schema.json
</code></pre></div></div> <p>Once completed, we will head over to Xcode and inside the GraphQL group, we will create three files for the three mutations: <code class="language-plaintext highlighter-rouge">CreatePost.graphql</code>, <code class="language-plaintext highlighter-rouge">EditPost.graphql</code> and <code class="language-plaintext highlighter-rouge">DeletePost.graphql</code>.</p> <p>Add the following snippets as content on these files respectively:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span> <span class="nx">CreatePost</span><span class="p">.</span><span class="nx">graphql</span>
<span class="nx">mutation</span> <span class="nx">CreatePost</span><span class="p">(</span><span class="nx">$input</span><span class="p">:</span> <span class="nx">PostInput</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">createPost</span><span class="p">(</span><span class="nx">input</span><span class="p">:</span> <span class="nx">$input</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span>
    <span class="nx">title</span>
    <span class="nx">publishedAt</span>
    <span class="nx">tags</span>
    <span class="nx">author</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">AuthorDetails</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span> <span class="nx">EditPost</span><span class="p">.</span><span class="nx">graphql</span>
<span class="nx">mutation</span> <span class="nx">EditPost</span><span class="p">(</span><span class="nx">$id</span><span class="p">:</span> <span class="nx">CustomUUID</span><span class="o">!</span><span class="p">,</span> <span class="nx">$title</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">,</span> <span class="nx">$tags</span><span class="p">:</span> <span class="p">[</span><span class="nx">Tag</span><span class="o">!</span><span class="p">]</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">editPost</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="nx">$id</span><span class="p">,</span> <span class="nx">tags</span><span class="p">:</span> <span class="nx">$tags</span><span class="p">,</span> <span class="nx">title</span><span class="p">:</span> <span class="nx">$title</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span>
    <span class="nx">title</span>
    <span class="nx">publishedAt</span>
    <span class="nx">tags</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span> <span class="nx">DeletePost</span><span class="p">.</span><span class="nx">graphql</span>
<span class="nx">mutation</span> <span class="nx">DeletePost</span><span class="p">(</span><span class="nx">$id</span><span class="p">:</span> <span class="nx">CustomUUID</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">deletePost</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="nx">$id</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>All those queries follow the same pattern. We set the arguments, pass them to the mutation, and define the result data. With all the queries in place, we will run the <code class="language-plaintext highlighter-rouge">apollo codegen:generate</code> command to update the <code class="language-plaintext highlighter-rouge">API.swift</code>.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./Pods/Apollo/scripts/apollo/bin/apollo codegen:generate <span class="nt">--target</span><span class="o">=</span>swift <span class="s1">'--includes=./**/*.graphql'</span> <span class="nt">--localSchemaFile</span><span class="o">=</span>./iOSGraphQL/GraphQL/schema.json <span class="nt">--passthroughCustomScalars</span> ./iOSGraphQL/GraphQL/API.swift
</code></pre></div></div> <p>Before adding the implementation for the mutation, let‚Äôs create a function that will be responsible for fetching the existing posts. The return type will be a <code class="language-plaintext highlighter-rouge">Future</code> with <code class="language-plaintext highlighter-rouge">[Post]</code> as the <code class="language-plaintext highlighter-rouge">Output</code> type and <code class="language-plaintext highlighter-rouge">GraphQLError</code> as the <code class="language-plaintext highlighter-rouge">Failure</code> type and it will look like the following snippet:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">fetchPosts</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Post</span><span class="p">],</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="kt">AllPostsQuery</span><span class="p">()</span>

    <span class="k">let</span> <span class="nv">future</span> <span class="o">=</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Post</span><span class="p">],</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">promise</span> <span class="k">in</span>
        <span class="kt">GraphQLClient</span><span class="o">.</span><span class="n">apollo</span><span class="o">.</span><span class="nf">fetch</span><span class="p">(</span><span class="nv">query</span><span class="p">:</span> <span class="n">query</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">result</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="kt">GraphQLError</span><span class="o">.</span><span class="n">fetchError</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="k">let</span> <span class="nv">posts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">Post</span><span class="p">(</span><span class="nv">post</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
            <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">posts</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">future</span>
<span class="p">}</span>
</code></pre></div></div> <p>In this snippet, we are creating an instance of the query that we want to perform and then we create a future. Inside the Future‚Äôs closure, we will initialize the fetch request and once it‚Äôs completed, we will try to get the response. If the response is an error, then we are going to reject the Future by passing an error to its promise. Otherwise, we will map the response to the <code class="language-plaintext highlighter-rouge">Post</code> model and then pass <code class="language-plaintext highlighter-rouge">.success</code> with this list of posts to the promise.</p> <p>For the scope of this post, the <code class="language-plaintext highlighter-rouge">GraphQLError</code> will be a simple Error enum:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">GraphQLError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">fetchError</span>
    <span class="k">case</span> <span class="n">createError</span>
    <span class="k">case</span> <span class="n">editError</span>
    <span class="k">case</span> <span class="n">deleteError</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now, let‚Äôs see how we can perform the mutation queries!</p> <p>Following the same logic as with the <code class="language-plaintext highlighter-rouge">fetchPosts</code>, we are going to add three more functions to create, update, and delete a post:</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">createPost</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="p">[</span><span class="kt">Tag</span><span class="p">],</span> <span class="nv">authorId</span><span class="p">:</span> <span class="kt">CustomUUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">CreatePostMutation</span><span class="o">.</span><span class="kt">Data</span><span class="o">.</span><span class="kt">CreatePost</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">input</span> <span class="o">=</span> <span class="kt">PostInput</span><span class="p">(</span><span class="nv">authorId</span><span class="p">:</span> <span class="n">authorId</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="n">title</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">mutation</span> <span class="o">=</span> <span class="kt">CreatePostMutation</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="n">input</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">future</span> <span class="o">=</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">CreatePostMutation</span><span class="o">.</span><span class="kt">Data</span><span class="o">.</span><span class="kt">CreatePost</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">promise</span> <span class="k">in</span>
            <span class="kt">GraphQLClient</span><span class="o">.</span><span class="n">apollo</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="nv">mutation</span><span class="p">:</span> <span class="n">mutation</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="k">let</span> <span class="nv">post</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">result</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">?</span><span class="o">.</span><span class="n">createPost</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="o">.</span><span class="n">createError</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">post</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">future</span>
    <span class="p">}</span>
</code></pre></div></div> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">editPost</span><span class="p">(</span><span class="n">with</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">CustomUUID</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="p">[</span><span class="kt">Tag</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">EditPostMutation</span><span class="o">.</span><span class="kt">Data</span><span class="o">.</span><span class="kt">EditPost</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">mutation</span> <span class="o">=</span> <span class="kt">EditPostMutation</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="n">tags</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">future</span> <span class="o">=</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">EditPostMutation</span><span class="o">.</span><span class="kt">Data</span><span class="o">.</span><span class="kt">EditPost</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">promise</span> <span class="k">in</span>
            <span class="kt">GraphQLClient</span><span class="o">.</span><span class="n">apollo</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="nv">mutation</span><span class="p">:</span> <span class="n">mutation</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="k">let</span> <span class="nv">post</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">result</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">?</span><span class="o">.</span><span class="n">editPost</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="o">.</span><span class="n">editError</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">post</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">future</span>
    <span class="p">}</span>
</code></pre></div></div> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">deletePost</span><span class="p">(</span><span class="n">with</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">CustomUUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">mutation</span> <span class="o">=</span> <span class="kt">DeletePostMutation</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">id</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">future</span> <span class="o">=</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="p">{</span> <span class="n">promise</span> <span class="k">in</span>
            <span class="kt">GraphQLClient</span><span class="o">.</span><span class="n">apollo</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="nv">mutation</span><span class="p">:</span> <span class="n">mutation</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">result</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">?</span><span class="o">.</span><span class="n">deletePost</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="o">.</span><span class="n">deleteError</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nf">promise</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">future</span>
    <span class="p">}</span>
</code></pre></div></div> <p>In all these 3 functions, we are following the same logic. We accept a set of arguments, which we use to create an instance of a mutation. Those Mutation classes were generated based on the GraphQL queries when we ran the <code class="language-plaintext highlighter-rouge">apollo codegen:generate</code> command.</p> <p>Then we create a future and inside its closure we perform the mutation request. Once it is completed, we check if the response is successful or not, and based on that we pass the corresponding result on the promise.</p> <p>Lastly, we will need to provide an extension for the <code class="language-plaintext highlighter-rouge">CustomUUID</code> structure to make it conform to the <code class="language-plaintext highlighter-rouge">JSONEncodable</code> protocol. This will allow us to use it as an argument on the GraphQL mutation queries.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">CustomUUID</span><span class="p">:</span> <span class="kt">JSONEncodable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">jsonValue</span><span class="p">:</span> <span class="kt">JSONValue</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">"value"</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">uuidString</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now, let‚Äôs see how we can use those functions to make the requests. <code class="language-plaintext highlighter-rouge">Future</code> conforms to <code class="language-plaintext highlighter-rouge">Publisher</code> which means that we can use any of the <code class="language-plaintext highlighter-rouge">Publisher</code>‚Äôs functions. In our case, we are going to use <code class="language-plaintext highlighter-rouge">flatMap</code> and <code class="language-plaintext highlighter-rouge">sink</code> to combine and trigger the sequence of operations.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cancellable</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">fetchPosts</span><span class="p">()</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">posts</span> <span class="k">in</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">createPost</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"New post"</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">swift</span><span class="p">],</span> <span class="nv">authorId</span><span class="p">:</span> <span class="n">posts</span><span class="o">.</span><span class="n">first</span><span class="o">!.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">post</span> <span class="o">-&gt;</span> <span class="kt">Future</span><span class="o">&lt;</span><span class="kt">EditPostMutation</span><span class="o">.</span><span class="kt">Data</span><span class="o">.</span><span class="kt">EditPost</span><span class="p">,</span> <span class="kt">GraphQLError</span><span class="o">&gt;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="nv">updatedTags</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span> <span class="o">+</span> <span class="p">[</span><span class="o">.</span><span class="n">vapor</span><span class="p">,</span> <span class="o">.</span><span class="n">graphQl</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">editPost</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="s">"Updated Title"</span><span class="p">,</span> <span class="nv">tags</span><span class="p">:</span> <span class="n">updatedTags</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">post</span> <span class="k">in</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">deletePost</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></div> <p>In this snippet, we first call <code class="language-plaintext highlighter-rouge">fetchPosts</code> to fetch the list of posts and then using <code class="language-plaintext highlighter-rouge">flatMap</code> we pass the response and trigger the next request. Finally, we call <code class="language-plaintext highlighter-rouge">sink</code>. As you can see from the snippet, <code class="language-plaintext highlighter-rouge">sink</code> takes two parameters. The first one (<code class="language-plaintext highlighter-rouge">receiveComplete</code>) is a closure that gets executed on completion, be it a success or an error, while the second one (<code class="language-plaintext highlighter-rouge">receiveValue</code>) is a closure that gets executed every time we receive a new value from the publisher.</p> <p>Since <code class="language-plaintext highlighter-rouge">Future</code> performs operations asynchronously, we need to keep a reference to the cancellable that the call to <code class="language-plaintext highlighter-rouge">sink</code> returns. Otherwise, Swift will destroy it by the time it exits the scope, and thus the closures will never get called.</p> <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// class scope</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">cancellable</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>
</code></pre></div></div> <p>Finally, make sure to call <code class="language-plaintext highlighter-rouge">cancellable?.cancel()</code> on the <code class="language-plaintext highlighter-rouge">deinit</code>.</p> <p>And that was it! If you now run the app, it will execute those queries in order. If you want to ‚Äúsee‚Äù the flow of events, you can use the <code class="language-plaintext highlighter-rouge">.print()</code> function between the <code class="language-plaintext highlighter-rouge">.flatMap</code> calls and it will print the events.</p> <blockquote> <p>All the code from this post is also available on <a href="https://github.com/diamantidis/ios-graphql/tree/94d390a">GitHub</a>.</p> </blockquote> <h2 id="conclusion">Conclusion</h2> <p>To sum up, in this post, we have made a brief introduction to Combine‚Äôs <code class="language-plaintext highlighter-rouge">Future</code> and <code class="language-plaintext highlighter-rouge">Promise</code> and we have seen how we can use them to perform GraphQL mutations. More specifically, we have seen how to implement the logic to sequentially create, edit, and delete a post.</p> <p>Thanks for reading, I hope you find this post useful.</p> <p>If you like this post and you want to get notified when a new post is published, you can follow me on <a href="https://twitter.com/diamantidis_io">Twitter</a> or subscribe to the <a href="https://diamantidis.github.io/feed.xml">RSS feed</a>.</p> <p>Also, if you have any questions or comments about this post, feel free to contact me on <a href="https://twitter.com/diamantidis_io">Twitter</a>!</p> <p>Until next time!</p> </div> <div class="socials"> <!-- Buy me a coffee button --> <a href="https://www.buymeacoffee.com/diamantidis" target="_blank"> <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" > </a> <div class="share"> <strong>Share: </strong> <a href="//twitter.com/share?text=GraphQL+mutations+for+iOS+apps+%28with+the+help+of+Combine%27s+Future%29&url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F06%2F14%2Fgraphql-mutations-for-ios-app" aria-label="Share on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.facebook.com/sharer.php?t=GraphQL+mutations+for+iOS+apps+%28with+the+help+of+Combine%27s+Future%29&u=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F06%2F14%2Fgraphql-mutations-for-ios-app" aria-label="Share on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i> </span> </a> <a href="//www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fdiamantidis.github.io%2F2020%2F06%2F14%2Fgraphql-mutations-for-ios-app" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </div></article> </div> </main><footer class="site-footer"> <data class="u-url" href="/"></data> <div class="footer-icons"> <ul> <li> <div class="social-icon"> <a href="https://twitter.com/diamantidis_io" aria-label="Twitter"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://github.com/diamantidis" aria-label="GitHub"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="http://linkedin.com/in/ioannis-diamantidis" aria-label="LinkedIn"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="https://instagram.com/diama.codes" aria-label="Instagram"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-instagram fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="/feed.xml" aria-label="RSS Feed"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-rss fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> <li> <div class="social-icon"> <a href="mailto:diamantidis@outlook.com" aria-label="Email"> <span class="fa-stack fa-lg"> <i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i> </span> </a> </div> </li> </ul> </div> <div class="wrapper"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i>, <a href="https://jekyllrb.com/">Jekyll</a> and <a href="https://pages.github.com/"> Github Pages</a> </p> <p> ¬© Copyright 2024 Ioannis Diamantidis </p> </div> </footer></body> </html>
